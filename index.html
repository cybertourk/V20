<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V20 Character Creator</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs (Imports handled in modules, but CDN links for context if needed) -->
</head>
<body class="bg-black text-white font-serif overflow-hidden h-screen flex flex-col">

    <!-- TOP BAR -->
    <header class="bg-[#1a0505] border-b border-[#4a0404] p-2 flex justify-between items-center shadow-lg z-50 h-12 flex-shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-[#8b0000] tracking-widest uppercase" style="text-shadow: 1px 1px 2px black;">V20<span class="text-xs text-gray-500 ml-1" id="app-version"></span></h1>
            
            <!-- File Name Input -->
            <input type="text" id="save-filename" placeholder="Character Name..." 
                   class="bg-black/50 border border-[#444] text-gray-300 text-xs px-2 py-1 w-48 rounded focus:border-[#d4af37] focus:outline-none">
            
            <button id="cmd-new" class="text-xs text-gray-400 hover:text-white uppercase font-bold"><i class="fas fa-file"></i> New</button>
            <button id="cmd-save" class="text-xs text-gray-400 hover:text-white uppercase font-bold"><i class="fas fa-save"></i> Save</button>
            <button id="cmd-load" class="text-xs text-gray-400 hover:text-white uppercase font-bold"><i class="fas fa-folder-open"></i> Load</button>
        </div>

        <div class="flex items-center gap-3">
            <button id="toggle-freebie-btn" class="border border-[#444] px-2 py-1 text-[10px] uppercase font-bold text-gray-400 hover:border-blue-500 hover:text-blue-200 transition-colors" disabled>
                <i class="fas fa-unlock-alt mr-1"></i> <span id="freebie-btn-text">Freebies</span>
            </button>
            <button id="play-mode-btn" class="bg-[#8b0000] text-white px-3 py-1 text-xs font-bold uppercase rounded shadow hover:bg-red-700 transition-colors border border-[#ff4444]">
                <i class="fas fa-gamepad mr-1"></i> <span id="play-btn-text">Play</span>
            </button>
        </div>
    </header>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#8b0000]"></div>
        <div class="mt-4 text-[#8b0000] font-bold tracking-widest animate-pulse">AWAKENING BLOOD...</div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- LEFT NAV (Phase Steps) -->
        <nav id="sheet-nav" class="w-16 bg-[#0f0f0f] border-r border-[#333] flex flex-col items-center py-4 gap-2 overflow-y-auto flex-shrink-0 z-40">
            <!-- Nav items injected by JS -->
        </nav>

        <!-- CENTER WORKSPACE -->
        <main class="flex-1 relative overflow-y-auto p-4 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
            
            <!-- Walkthrough Guide Overlay -->
            <div id="walkthrough-guide" class="absolute top-4 right-4 z-30 flex items-center gap-2 pointer-events-none transition-opacity duration-300">
                <div id="guide-message" class="bg-black/90 border border-[#d4af37] text-[#f0e6d2] px-4 py-2 rounded text-xs font-bold shadow-lg w-48 text-right">
                    Initialize...
                </div>
                <div id="guide-icon" class="w-10 h-10 rounded-full bg-[#1a0505] border-2 border-[#d4af37] flex items-center justify-center text-[#d4af37] shadow-lg cursor-pointer pointer-events-auto hover:scale-110 transition-transform" onclick="window.nextStep()">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <!-- STEP 1: CONCEPT -->
            <div id="phase-1" class="step-container active">
                <h2 class="section-header">Character Concept</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label>Name</label><input type="text" id="c-name" class="w-full">
                    </div>
                    <div class="form-group">
                        <label>Player</label><input type="text" id="c-player" class="w-full">
                    </div>
                    <div class="form-group">
                        <label>Chronicle</label><input type="text" id="c-chronicle" class="w-full">
                    </div>
                    <div class="form-group">
                        <label>Nature</label><select id="c-nature" class="w-full"></select>
                    </div>
                    <div class="form-group">
                        <label>Demeanor</label><select id="c-demeanor" class="w-full"></select>
                    </div>
                    <div class="form-group">
                        <label>Concept</label><input type="text" id="c-concept" class="w-full">
                    </div>
                    <div class="form-group">
                        <label>Clan</label><select id="c-clan" class="w-full"></select>
                    </div>
                    <div class="form-group">
                        <label>Generation</label><input type="number" id="c-gen" value="13" min="4" max="15" class="w-full">
                    </div>
                    <div class="form-group">
                        <label>Sire</label><input type="text" id="c-sire" class="w-full">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="label-text">Clan Weakness Info (Auto)</label>
                    <textarea id="c-clan-weakness" class="w-full h-20 bg-black/20 text-gray-400 text-xs p-2 border border-[#333]" readonly></textarea>
                </div>
            </div>

            <!-- STEP 2: ATTRIBUTES -->
            <div id="phase-2" class="step-container">
                <h2 class="section-header">Attributes <span class="text-xs text-gray-400 ml-2 font-normal">(7/5/3)</span></h2>
                <div class="grid grid-cols-3 gap-6">
                    <!-- Physical -->
                    <div class="sheet-section">
                        <div class="column-title flex justify-between">
                            Physical <span id="p-phys" class="text-[#d4af37] text-[10px]">[0]</span>
                        </div>
                        <div class="flex justify-center gap-1 mb-2">
                            <button class="prio-btn" data-cat="attr" data-group="Physical" data-v="7">Pri</button>
                            <button class="prio-btn" data-cat="attr" data-group="Physical" data-v="5">Sec</button>
                            <button class="prio-btn" data-cat="attr" data-group="Physical" data-v="3">Ter</button>
                        </div>
                        <div id="list-attr-physical"></div>
                    </div>
                    <!-- Social -->
                    <div class="sheet-section">
                        <div class="column-title flex justify-between">
                            Social <span id="p-social" class="text-[#d4af37] text-[10px]">[0]</span>
                        </div>
                        <div class="flex justify-center gap-1 mb-2">
                            <button class="prio-btn" data-cat="attr" data-group="Social" data-v="7">Pri</button>
                            <button class="prio-btn" data-cat="attr" data-group="Social" data-v="5">Sec</button>
                            <button class="prio-btn" data-cat="attr" data-group="Social" data-v="3">Ter</button>
                        </div>
                        <div id="list-attr-social"></div>
                    </div>
                    <!-- Mental -->
                    <div class="sheet-section">
                        <div class="column-title flex justify-between">
                            Mental <span id="p-mental" class="text-[#d4af37] text-[10px]">[0]</span>
                        </div>
                        <div class="flex justify-center gap-1 mb-2">
                            <button class="prio-btn" data-cat="attr" data-group="Mental" data-v="7">Pri</button>
                            <button class="prio-btn" data-cat="attr" data-group="Mental" data-v="5">Sec</button>
                            <button class="prio-btn" data-cat="attr" data-group="Mental" data-v="3">Ter</button>
                        </div>
                        <div id="list-attr-mental"></div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: ABILITIES -->
            <div id="phase-3" class="step-container">
                <h2 class="section-header">Abilities <span class="text-xs text-gray-400 ml-2 font-normal">(13/9/5)</span></h2>
                <div class="grid grid-cols-3 gap-6">
                    <!-- Talents -->
                    <div class="sheet-section">
                        <div class="column-title flex justify-between">
                            Talents <span id="p-tal" class="text-[#d4af37] text-[10px]">[0]</span>
                        </div>
                        <div class="flex justify-center gap-1 mb-2">
                            <button class="prio-btn" data-cat="abil" data-group="Talents" data-v="13">Pri</button>
                            <button class="prio-btn" data-cat="abil" data-group="Talents" data-v="9">Sec</button>
                            <button class="prio-btn" data-cat="abil" data-group="Talents" data-v="5">Ter</button>
                        </div>
                        <div id="list-abil-talents"></div>
                        <div class="mt-2 border-t border-[#333] pt-1"><div class="text-[9px] text-gray-500 mb-1">CUSTOM TALENTS</div><div id="custom-talents"></div></div>
                    </div>
                    <!-- Skills -->
                    <div class="sheet-section">
                        <div class="column-title flex justify-between">
                            Skills <span id="p-ski" class="text-[#d4af37] text-[10px]">[0]</span>
                        </div>
                        <div class="flex justify-center gap-1 mb-2">
                            <button class="prio-btn" data-cat="abil" data-group="Skills" data-v="13">Pri</button>
                            <button class="prio-btn" data-cat="abil" data-group="Skills" data-v="9">Sec</button>
                            <button class="prio-btn" data-cat="abil" data-group="Skills" data-v="5">Ter</button>
                        </div>
                        <div id="list-abil-skills"></div>
                        <div class="mt-2 border-t border-[#333] pt-1"><div class="text-[9px] text-gray-500 mb-1">CUSTOM SKILLS</div><div id="custom-skills"></div></div>
                    </div>
                    <!-- Knowledges -->
                    <div class="sheet-section">
                        <div class="column-title flex justify-between">
                            Knowledges <span id="p-kno" class="text-[#d4af37] text-[10px]">[0]</span>
                        </div>
                        <div class="flex justify-center gap-1 mb-2">
                            <button class="prio-btn" data-cat="abil" data-group="Knowledges" data-v="13">Pri</button>
                            <button class="prio-btn" data-cat="abil" data-group="Knowledges" data-v="9">Sec</button>
                            <button class="prio-btn" data-cat="abil" data-group="Knowledges" data-v="5">Ter</button>
                        </div>
                        <div id="list-abil-knowledges"></div>
                        <div class="mt-2 border-t border-[#333] pt-1"><div class="text-[9px] text-gray-500 mb-1">CUSTOM KNOWLEDGES</div><div id="custom-knowledges"></div></div>
                    </div>
                </div>
            </div>

            <!-- STEP 4: ADVANTAGES -->
            <div id="phase-4" class="step-container">
                <h2 class="section-header">Advantages</h2>
                <div class="grid grid-cols-3 gap-6">
                    <div class="sheet-section">
                        <div class="column-title">Disciplines <span id="p-disc" class="text-[#d4af37] text-[10px]">[3]</span></div>
                        <div id="list-disc"></div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Backgrounds <span id="p-back" class="text-[#d4af37] text-[10px]">[5]</span></div>
                        <div id="list-back"></div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Virtues <span id="p-virt" class="text-[#d4af37] text-[10px]">[7]</span></div>
                        <div id="list-virt"></div>
                    </div>
                </div>
            </div>

            <!-- STEP 5: POSSESSIONS -->
            <div id="phase-5" class="step-container">
                <h2 class="section-header">Possessions & Assets</h2>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Inventory Management -->
                    <div class="sheet-section">
                        <div class="column-title">Inventory</div>
                        <div class="flex flex-col gap-2 mb-2 bg-[#111] p-2 border border-[#333]">
                            <select id="inv-type" class="w-full text-xs bg-black text-white border border-[#444] p-1">
                                <option value="Item">General Item</option>
                                <option value="Weapon">Weapon</option>
                                <option value="Armor">Armor</option>
                                <option value="Vehicle">Vehicle</option>
                            </select>
                            <div id="inv-base-wrapper" class="hidden">
                                <select id="inv-base-select" class="w-full text-xs bg-black text-white border border-[#444] p-1"></select>
                            </div>
                            <input type="text" id="inv-name" placeholder="Item Name..." class="w-full text-xs bg-black text-white border border-[#444] p-1">
                            <div class="flex items-center gap-2"><input type="checkbox" id="inv-carried"> <span class="text-xs text-gray-400">Carried?</span></div>
                            
                            <!-- Dynamic Stats Inputs -->
                            <div id="inv-stats-row" class="hidden grid grid-cols-5 gap-1">
                                <input type="text" id="inv-diff" placeholder="Diff" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-dmg" placeholder="Dmg" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-range" placeholder="Rng" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-rate" placeholder="Rate" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-clip" placeholder="Clip" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                            </div>
                            <div id="inv-armor-row" class="hidden grid grid-cols-2 gap-1">
                                <input type="text" id="inv-rating" placeholder="Rating (1-5)" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-penalty" placeholder="Dex Penalty" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                            </div>
                            <div id="inv-vehicle-row" class="hidden grid grid-cols-3 gap-1">
                                <input type="text" id="inv-safe" placeholder="Safe Spd" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-max" placeholder="Max Spd" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                                <input type="text" id="inv-man" placeholder="Maneuver" class="text-[9px] bg-black text-white border border-[#444] p-1 text-center">
                            </div>

                            <button id="add-inv-btn" class="bg-[#222] text-xs py-1 border border-[#444] hover:bg-[#333]">Add Item</button>
                        </div>
                        <div class="h-48 overflow-y-auto">
                            <div class="text-[10px] text-gray-500 font-bold border-b border-[#333] mb-1">CARRIED</div>
                            <div id="inv-list-carried"></div>
                            <div class="text-[10px] text-gray-500 font-bold border-b border-[#333] mt-2 mb-1">OWNED / STASHED</div>
                            <div id="inv-list-owned"></div>
                            <div class="text-[10px] text-gray-500 font-bold border-b border-[#333] mt-2 mb-1">VEHICLES</div>
                            <div id="vehicle-list"></div>
                        </div>
                    </div>
                    
                    <!-- Havens -->
                    <div class="sheet-section">
                        <div class="column-title">Havens</div>
                        <div id="multi-haven-list" class="h-64 overflow-y-auto pr-1">
                            <!-- Dynamic Havens -->
                        </div>
                        <button class="w-full text-[10px] text-gray-400 bg-[#111] border border-[#333] py-1 hover:text-white" onclick="window.renderDynamicHavenRow()">+ Add Haven</button>
                    </div>
                </div>
            </div>

            <!-- STEP 6: MERITS & FLAWS -->
            <div id="phase-6" class="step-container">
                <h2 class="section-header">Merits & Flaws</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="sheet-section">
                        <div class="column-title">Merits</div>
                        <div id="merit-locked-msg" class="text-xs text-gray-500 italic p-2 hidden">Merits are purchased with Freebie Points (Step 8). Enable Freebie Mode to edit.</div>
                        <div id="merits-list-create"></div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Flaws</div>
                        <div id="flaw-locked-msg" class="text-xs text-gray-500 italic p-2 hidden">Flaws grant Freebie Points (Step 8). Enable Freebie Mode to edit.</div>
                        <div id="flaws-list-create"></div>
                    </div>
                </div>
            </div>

            <!-- STEP 7: BIOGRAPHY -->
            <div id="phase-7" class="step-container">
                <h2 class="section-header">Biography & Details</h2>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Vitals -->
                    <div class="sheet-section">
                        <div class="column-title">Vitals</div>
                        <div id="vitals-create-inputs" class="grid grid-cols-2 gap-2"></div>
                        <label class="label-text mt-2">Feeding Grounds</label>
                        <textarea id="inv-feeding-grounds" class="w-full h-16 bg-black/40 border border-[#333] text-xs p-1"></textarea>
                    </div>
                    <!-- History -->
                    <div class="sheet-section">
                        <div class="column-title">History</div>
                        <textarea id="char-history" class="w-full h-40 bg-black/40 border border-[#333] text-white p-2 text-xs" placeholder="Character Backstory..."></textarea>
                    </div>
                    <!-- Goals -->
                    <div class="sheet-section col-span-2">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-text">Goals</label>
                                <textarea id="bio-goals-st" class="w-full h-16 bg-black/40 border border-[#333] text-xs p-1" placeholder="Short Term Goals..."></textarea>
                                <textarea id="bio-goals-lt" class="w-full h-16 bg-black/40 border border-[#333] text-xs p-1 mt-1" placeholder="Long Term Goals..."></textarea>
                            </div>
                            <div>
                                <label class="label-text">Description</label>
                                <textarea id="bio-desc" class="w-full h-20 bg-black/40 border border-[#333] text-xs p-1" placeholder="Visual Description..."></textarea>
                                <label class="label-text mt-1">Languages</label>
                                <textarea id="bio-languages" class="w-full h-12 bg-black/40 border border-[#333] text-xs p-1" placeholder="Languages..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 8: FINALIZE / FREEBIES -->
            <div id="phase-8" class="step-container">
                <h2 class="section-header">Finalize & Freebie Points</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div class="sheet-section">
                        <div class="column-title">Starting Status</div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="label-text">Humanity/Path</span>
                            <div id="phase8-humanity-dots" class="dot-row"></div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="label-text">Willpower</span>
                            <div id="phase8-willpower-dots" class="dot-row"></div>
                        </div>
                        <div class="mt-4">
                            <label class="label-text">Path Name</label>
                            <select id="c-path-name-create" class="w-full text-xs bg-black text-white p-1 border border-[#333]"></select>
                        </div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Other Traits</div>
                        <div id="other-traits-rows-create"></div>
                    </div>
                </div>
                <div class="bg-gray-900/50 p-4 border border-[#444] mt-4 text-center">
                    <h3 class="text-gold font-bold mb-2">Review Character</h3>
                    <p class="text-xs text-gray-400 mb-4">Ensure all dots are spent and freebie points are balanced. (Standard: 15 Freebies)</p>
                    <button id="confirm-save-btn" class="bg-[#d4af37] text-black px-6 py-2 font-bold uppercase rounded hover:bg-white transition-colors">Save Character</button>
                </div>
            </div>

            <!-- PLAY MODE SHEET -->
            <div id="play-mode-sheet" class="hidden">
                <!-- Header Grid -->
                <div class="grid grid-cols-3 gap-2 bg-[#1a0505] p-2 border-b-2 border-[#8b0000] mb-4 text-[10px]" id="play-concept-row">
                    <!-- Populated by JS -->
                </div>

                <!-- Attributes & Abilities -->
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="col-span-1" id="play-row-attr"></div>
                    <div class="col-span-1" id="play-row-abil"></div>
                    <div class="col-span-1" id="play-row-adv"></div>
                </div>

                <!-- Status Row -->
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <!-- Humanity/Willpower -->
                    <div class="sheet-section">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold text-gray-400">HUMANITY / PATH</span>
                            <div id="humanity-dots-play" class="dot-row scale-75 origin-right"></div>
                        </div>
                        <div class="mb-2">
                            <div class="text-[9px] text-[#d4af37] text-right" id="play-path-label"></div>
                            <div class="flex justify-between text-[9px] text-gray-500">
                                <span>Bearing:</span> <span id="c-bearing-display" class="text-white"></span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-1 pt-2 border-t border-[#333]">
                            <span class="text-[10px] font-bold text-gray-400">WILLPOWER</span>
                            <div id="willpower-dots-play" class="dot-row scale-75 origin-right"></div>
                        </div>
                        <div id="willpower-boxes-play" class="flex justify-end gap-1 mt-1"></div>
                    </div>

                    <!-- Blood Pool -->
                    <div class="sheet-section text-center">
                        <div class="text-[10px] font-bold text-[#8b0000] mb-2">BLOOD POOL</div>
                        <div id="blood-boxes-play" class="grid grid-cols-10 gap-1 justify-center px-4"></div>
                        <div class="text-[9px] text-gray-500 mt-2">Click to spend/regain</div>
                    </div>

                    <!-- Health & Weakness Row (Updated) -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Health (Left) -->
                        <div class="sheet-section">
                            <div class="text-[10px] font-bold text-gray-400 mb-1 text-center">HEALTH</div>
                            <div id="health-chart-play" class="flex flex-col gap-1"></div>
                        </div>
                        
                        <!-- Weakness (Right) - Explicit container -->
                        <div class="sheet-section" id="weakness-play-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Combat & Equipment -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="sheet-section">
                        <div class="column-title">Combat Actions</div>
                        <table class="w-full text-left">
                            <thead class="text-[9px] text-gray-500 border-b border-[#333]">
                                <tr><th>Weapon</th><th>Diff</th><th>Dmg</th><th>Rng</th><th>Rate</th><th>Clip</th></tr>
                            </thead>
                            <tbody id="combat-rows-play"></tbody>
                        </table>
                        <div class="mt-2 text-[10px] flex justify-between border-t border-[#333] pt-1">
                            <span>Armor: <span id="armor-desc-play" class="text-white">None</span></span>
                            <span class="text-gray-400">Rating: <span id="armor-rating-play" class="text-white">0</span> Penalty: <span id="armor-penalty-play" class="text-white">0</span></span>
                        </div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Inventory & Vehicles</div>
                        <div class="text-[10px] mb-2"><span class="text-gray-500">Carried:</span> <span id="play-gear-carried" class="text-white"></span></div>
                        <div class="text-[10px] mb-2"><span class="text-gray-500">Owned:</span> <span id="play-gear-owned" class="text-white"></span></div>
                        <div id="play-vehicles" class="mt-2"></div>
                    </div>
                </div>

                <!-- Expanded Details -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="sheet-section">
                        <div class="column-title">Merits & Flaws</div>
                        <div id="merit-flaw-rows-play"></div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Other Traits</div>
                        <div id="other-traits-rows-play"></div>
                        <div class="column-title mt-4">Derangements</div>
                        <div id="play-derangements" class="text-[10px] text-red-300"></div>
                        <div class="column-title mt-4">Blood Bonds</div>
                        <div id="play-blood-bonds"></div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Social / Backgrounds</div>
                        <div id="play-social-grid"></div>
                        <div class="mt-4">
                            <div class="column-title">Rituals</div>
                            <div id="rituals-list-play" class="text-[10px] text-gray-300 whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="sheet-section">
                        <div class="column-title">Biography</div>
                        <div id="play-vitals-list"></div>
                        <div class="mt-2 text-[10px]"><span class="text-gray-500 font-bold">Languages:</span> <span id="play-languages"></span></div>
                        <div class="mt-2 text-[10px]"><span class="text-gray-500 font-bold">Description:</span> <div id="play-bio-desc" class="text-gray-300 italic"></div></div>
                        <div class="mt-2 text-[10px]"><span class="text-gray-500 font-bold">Feeding Grounds:</span> <div id="play-feeding-grounds" class="text-gray-300"></div></div>
                        <div class="mt-2 text-[10px]"><span class="text-gray-500 font-bold">Havens:</span> <div id="play-havens-list" class="mt-1"></div></div>
                    </div>
                    <div class="sheet-section">
                        <div class="column-title">Goals & History</div>
                        <div class="text-[10px] mb-2"><span class="text-gold font-bold">Short Term:</span> <div id="play-goals-st"></div></div>
                        <div class="text-[10px] mb-2"><span class="text-gold font-bold">Long Term:</span> <div id="play-goals-lt"></div></div>
                        <div class="text-[10px] mt-4"><span class="text-gray-500 font-bold">History:</span> <div id="play-history" class="h-24 overflow-y-auto text-gray-300"></div></div>
                    </div>
                </div>

            </div>

        </main>

        <!-- RIGHT SIDEBAR (Freebie Calc & Dice) -->
        <aside id="freebie-sidebar" class="w-64 bg-[#111] border-l border-[#333] flex flex-col z-40 transform translate-x-full transition-transform duration-300 fixed right-0 top-12 bottom-0">
            <div class="bg-[#1a0505] p-2 border-b border-[#444] flex justify-between items-center cursor-pointer" onclick="window.toggleSidebarLedger()">
                <h3 class="text-sm font-bold text-gold uppercase">Freebie Ledger</h3>
                <span class="text-xs text-gray-400"><i class="fas fa-chevron-left"></i></span>
            </div>
            
            <div class="p-2 flex-1 overflow-y-auto text-xs">
                <div class="flex justify-between border-b border-[#333] py-1"><span>Attributes (5/dot)</span> <span id="sb-attr" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Abilities (2/dot)</span> <span id="sb-abil" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Disciplines (7/dot)</span> <span id="sb-disc" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Backgrounds (1/dot)</span> <span id="sb-back" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Virtues (2/dot)</span> <span id="sb-virt" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Humanity (2/dot)</span> <span id="sb-human" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Willpower (1/dot)</span> <span id="sb-will" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Merits (Variable)</span> <span id="sb-merit" class="text-red-400">0</span></div>
                <div class="flex justify-between border-b border-[#333] py-1"><span>Flaws (Bonus)</span> <span id="sb-flaw" class="text-green-400">0</span></div>
                
                <div class="mt-4 pt-2 border-t border-gray-500 font-bold flex justify-between text-sm">
                    <span>TOTAL SPENT:</span> <span id="f-total-top" class="text-white">0</span>
                </div>
                <div class="flex justify-between mt-1 text-sm">
                    <span>REMAINING:</span> <span id="sb-total" class="text-gold">15</span>
                </div>
                
                <div class="mt-4">
                    <label class="label-text">Freebie Limit Override</label>
                    <input type="number" id="c-freebie-total" value="15" class="w-full bg-black border border-[#444] text-center">
                </div>
            </div>
        </aside>

        <!-- DICE TRAY (Bottom Overlay) -->
        <div id="dice-tray" class="fixed bottom-0 right-0 w-64 bg-[#0f0f0f] border-t border-l border-[#d4af37] p-2 transform translate-y-full transition-transform duration-300 z-50">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gold font-bold text-xs uppercase"><i class="fas fa-dice-d20"></i> Dice Tray</span>
                <button onclick="window.clearPool()" class="text-[10px] text-gray-500 hover:text-white">CLEAR</button>
            </div>
            <div id="pool-display" class="text-[10px] text-white mb-2 h-8 overflow-hidden">Select traits...</div>
            <div class="flex gap-1 mb-2">
                <input type="number" id="roll-diff" value="6" min="2" max="10" class="w-10 text-center bg-black text-white border border-[#444] text-xs" title="Difficulty">
                <button onclick="window.rollPool()" class="flex-1 bg-[#8b0000] text-white text-xs font-bold uppercase rounded hover:bg-red-700">ROLL</button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="use-specialty"> <label for="use-specialty" class="text-[10px] text-gray-400">Specialty (10=2)</label>
            </div>
            <div id="roll-results" class="h-32 overflow-y-auto bg-black/50 border border-[#333] p-1"></div>
        </div>

    </div>

    <!-- MODALS -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center">
        <div class="bg-[#1a0505] border border-[#d4af37] p-4 w-96 shadow-2xl relative">
            <h3 id="modal-title" class="text-lg font-bold text-gold mb-2 uppercase">Alert</h3>
            <div id="modal-content" class="text-sm text-gray-300 mb-4"></div>
            <div class="flex justify-end gap-2">
                <button id="modal-cancel" class="text-xs text-gray-400 uppercase hover:text-white hidden">Cancel</button>
                <button id="modal-ok" class="bg-[#8b0000] text-white px-4 py-1 text-xs font-bold uppercase hover:bg-red-700">OK</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="notification" class="fixed top-16 left-1/2 transform -translate-x-1/2 bg-black/90 text-white px-6 py-2 rounded border border-[#d4af37] shadow-xl z-[70] hidden text-xs font-bold uppercase tracking-wider"></div>

    <!-- SCRIPTS -->
    <!-- Note: type="module" allows imports in main.js -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="data.js"></script>
    <script type="module" src="v20-rules.js"></script>
    <script type="module" src="ui-renderer.js"></script>
    <script type="module" src="firebase-manager.js"></script>
    <script type="module" src="main.js"></script>

</body>
</html>
