<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V20 Official Neonate Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap');

        :root {
            --v-blood: #af0000;
            --v-blood-bright: #ff1a1a;
            --v-dark: #050505;
            --v-parchment: #f0e6d2;
            --v-gold: #d4af37;
            --v-border: #4a4a4a;
        }

        body {
            background-color: var(--v-dark);
            color: var(--v-parchment);
            font-family: 'IM Fell English', serif;
            background-image: radial-gradient(circle at center, #1a0000 0%, #050505 100%);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            padding-top: 70px; /* Increased for new header */
            padding-bottom: 80px; /* Space for mobile nav */
        }
        
        @media (min-width: 768px) {
            body { padding-bottom: 0; padding-right: 60px; } /* Space for desktop nav */
        }

        h1, h2, h3, .heading { font-family: 'Cinzel', serif; letter-spacing: 0.1em; }
        .font-cinzel { font-family: 'Cinzel', serif; }

        /* Scrollbar aesthetics */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--v-blood); }

        .dot {
            width: 12px;
            height: 12px;
            border: 1px solid var(--v-blood);
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
            cursor: pointer;
            transition: 0.2s;
        }
        .dot.filled { 
            background-color: var(--v-blood); 
            box-shadow: 0 0 5px var(--v-blood); 
        }

        .box {
            width: 14px;
            height: 14px;
            border: 1px solid #777;
            display: inline-block;
            margin: 0 2px;
            cursor: pointer;
        }
        .box.checked { background-color: var(--v-blood); border-color: var(--v-blood-bright); }

        .sheet-section { border: 1px solid var(--v-border); padding: 1.5rem 1rem 1rem 1rem; background: rgba(0,0,0,0.5); position: relative; margin-top: 1.5rem; }
        .section-title { 
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #111; 
            color: var(--v-parchment); 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            padding: 0 15px;
            font-weight: bold;
            border: 1px solid var(--v-gold);
            white-space: nowrap;
            letter-spacing: 0.2em;
        }

        input, select, textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--v-border);
            color: white;
            width: 100%;
            padding: 2px 5px;
            font-family: 'IM Fell English', serif;
            font-size: 0.95rem;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-bottom-color: var(--v-gold); background: rgba(255,255,255,0.05); }
        textarea { border: 1px solid var(--v-border); resize: none; }
        input:disabled, select:disabled, textarea:disabled { border-bottom: none; color: var(--v-parchment); opacity: 0.9; cursor: default; }
        
        select option { background: #111; color: white; }

        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- NEW TOP BAR STYLES --- */
        #main-menubar {
            background: linear-gradient(to bottom, #111, #050505);
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            border-bottom: 2px solid #500;
        }

        /* --- RIGHT DOCK --- */
        #sheet-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(5, 5, 5, 0.95);
            border-top: 1px solid #333;
            z-index: 40; /* Below Top Bar (50) */
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
        }

        .nav-item { 
            cursor: pointer; 
            color: #555; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            text-align: center; 
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid transparent;
        }

        .nav-item i { font-size: 1.2rem; transition: color 0.3s; }
        .nav-item span { display: none; }

        @media(min-width: 768px) {
            #sheet-nav {
                top: 50%;
                bottom: auto;
                left: auto;
                right: 0;
                width: auto;
                height: auto;
                transform: translateY(-50%);
                flex-direction: column;
                background: transparent;
                border: none;
                gap: 0.8rem;
                padding: 1rem 0.5rem;
            }

            .nav-item {
                background: rgba(10, 10, 10, 0.9);
                border: 1px solid #333;
                border-right: none; 
                border-radius: 8px 0 0 8px;
                width: 50px;
                height: 50px;
                box-shadow: -3px 3px 10px rgba(0,0,0,0.5);
                margin-right: -5px;
            }

            .nav-item:hover {
                width: 60px;
                background: var(--v-blood);
                border-color: var(--v-gold);
                margin-right: 0;
            }

            .nav-item.active {
                background: var(--v-blood);
                border-color: var(--v-gold);
                width: 60px;
                box-shadow: 0 0 15px var(--v-blood);
                z-index: 10;
            }

            .nav-item.completed { border-color: #4ade80; }
            .nav-item i { font-size: 1.4rem; }
            .nav-item.active i, .nav-item:hover i { color: white !important; }

            .nav-item span {
                display: block;
                position: absolute;
                right: 120%;
                top: 50%;
                transform: translateY(-50%) translateX(10px);
                background: black;
                color: var(--v-gold);
                padding: 0.4rem 0.8rem;
                border: 1px solid var(--v-gold);
                border-radius: 4px;
                font-family: 'Cinzel', serif;
                font-size: 0.7rem;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-weight: bold;
                box-shadow: 0 0 10px rgba(0,0,0,0.8);
            }

            .nav-item:hover span { opacity: 1; transform: translateY(-50%) translateX(0); }
        }

        .nav-item.completed i { color: #4ade80; }
        .nav-item.locked { pointer-events: none; opacity: 0.3; }

        .pool-counter { font-size: 11px; color: var(--v-gold); text-transform: uppercase; margin-left: 5px; font-weight: bold; }

        .prio-btn { transition: 0.2s; background: rgba(255,255,255,0.05); color: #aaa; border: 1px solid #555; padding: 2px 10px; font-size: 11px; font-weight: bold; }
        .prio-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .prio-btn.active { background-color: var(--v-blood); color: white; border-color: var(--v-gold); }

        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 0, 0, 0.95);
            border: 1px solid var(--v-gold);
            color: white;
            padding: 12px 24px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            z-index: 10000;
            display: none;
            box-shadow: 0 0 25px rgba(139, 0, 0, 0.6);
        }

        .trait-label { cursor: default; transition: color 0.2s; color: var(--v-parchment); font-weight: bold; }
        .play-mode .trait-label { cursor: pointer; color: var(--v-gold); }
        .play-mode .trait-label.selected { color: white; background: var(--v-blood); padding: 0 6px; border-radius: 2px; box-shadow: 0 0 8px var(--v-blood); }
        .play-mode .trait-label:hover { color: white; text-shadow: 0 0 10px var(--v-gold); }
        .play-mode .dot { cursor: default !important; }

        #dice-tray {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 340px;
            background: rgba(10,10,10,0.98);
            border-left: 1px solid var(--v-gold);
            border-top: 1px solid var(--v-gold);
            z-index: 9999;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
        }
        #dice-tray.open { transform: translateY(0); }

        /* Freebie Sidebar */
        #freebie-sidebar {
            position: fixed;
            left: -210px;
            top: 55%; /* Moved down slightly to not hit top bar */
            transform: translateY(-50%);
            width: 210px;
            background: rgba(10,10,10,0.95);
            border: 1px solid var(--v-gold);
            padding: 1rem;
            transition: left 0.3s ease;
            z-index: 50;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            display: none;
        }
        #freebie-sidebar.active { display: block; }
        #freebie-sidebar.open { left: 0; }

        #sb-toggle-btn {
            position: absolute;
            right: -24px;
            top: 0;
            width: 24px;
            height: 80px;
            background: var(--v-blood);
            border: 1px solid var(--v-gold);
            border-left: none;
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        #sb-toggle-btn:hover { background: #d00000; }
        
        /* UPDATED LEDGER STYLES - Compact spacing */
        .cost-row { 
            display: flex; 
            justify-content: flex-start; /* Keeps items packed left */
            align-items: baseline; 
            font-size: 0.75rem; 
            padding: 4px 0; 
            width: 100%;
            gap: 1rem; /* Modest gap between text and number */
        }
        .cost-row > span:first-child { 
            flex-grow: 0; 
            white-space: nowrap; 
            color: #aaa; 
        }
        .cost-row > span:first-child::after { content: none; }
        .cost-val { 
            color: var(--v-gold); 
            font-weight: bold; 
            background: rgba(10,10,10,0.95);
            z-index: 2;
            flex-shrink: 0;
        }

        .dice-result { font-family: 'Cinzel', serif; font-size: 1.25rem; display: inline-block; margin: 4px; padding: 4px 10px; border: 1px solid #555; background: #111; font-weight: bold; }
        .dice-success { border-color: var(--v-gold); color: var(--v-gold); box-shadow: 0 0 8px var(--v-gold); }
        .dice-critical { border-color: var(--v-gold); color: white; background: var(--v-blood); box-shadow: 0 0 12px var(--v-gold); }
        .dice-botch { border-color: #ff0000; color: #ff0000; background: rgba(255,0,0,0.1); }

        #specialty-container { display: none; }
        #specialty-container.active { display: flex; }

        .label-text { font-size: 10px; text-transform: uppercase; font-weight: 800; color: #bba; letter-spacing: 0.05em; margin-bottom: 2px; display: block; }
        .standard-button { border: 1px solid #666; background: rgba(255,255,255,0.05); transition: 0.2s; color: white; }
        .standard-button:hover { background: rgba(255,255,255,0.15); border-color: #888; }
        .standard-button:disabled { opacity: 0.3; cursor: not-allowed; }

        .column-title { text-align: center; font-size: 0.7rem; font-weight: 900; letter-spacing: 0.3em; border-bottom: 1px solid var(--v-border); margin-bottom: 0.75rem; padding-bottom: 0.2rem; color: #888; text-transform: uppercase; }

        .remove-btn { color: var(--v-gold); font-weight: bold; padding: 0 8px; cursor: pointer; transition: 0.2s; font-size: 14px; width: 24px; text-align: center; }
        .remove-btn:hover { color: #fff; text-shadow: 0 0 5px var(--v-gold); }

        /* Freebie Mode Styles */
        body.freebie-mode .dot:hover { border-color: #00ff00; }
        .freebie-active-indicator { display: none; color: #4ade80; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; font-weight: bold; margin-left: 10px; }
        body.freebie-mode .freebie-active-indicator { display: inline-block; animation: pulse 2s infinite; }
        
        #top-freebie-counter { display: none; align-items: center; gap: 4px; border-left: 1px solid #444; padding-left: 10px; margin-left: 4px; }
        body.freebie-mode #top-freebie-counter { display: flex; }

        /* Guide Styles */
        #walkthrough-guide { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        #guide-icon.ready { border-color: #4ade80; box-shadow: 0 0 20px #4ade80; animation: pulse-green 2s infinite; }
        #guide-icon:hover { transform: scale(1.1); }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        
        @media print {
            body { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            #loading-overlay, nav, #main-menubar, #sheet-nav, #notification, button, #dice-tray, #freebie-sidebar, #walkthrough-guide { display: none !important; }
            .step-container { display: block !important; opacity: 1 !important; }
            .sheet-section { border-color: #000 !important; background: none !important; color: black !important; }
            .section-title { background: white !important; color: black !important; border-color: black !important; }
        }
    </style>
</head>
<body class="p-2 md:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-[9999]">
        <h1 class="text-[#8b0000] text-7xl font-bold animate-pulse tracking-[0.5em] heading">V20</h1>
        <p class="text-[11px] text-gray-400 tracking-[0.4em] mt-6 uppercase font-bold">Initializing Official Log...</p>
    </div>

    <div id="notification"></div>
    
    <!-- BRANDED TOP NAVIGATION BAR -->
    <nav id="main-menubar" class="fixed top-0 left-0 w-full h-16 bg-[#050505] border-b-2 border-[#500] z-50 flex items-center justify-between px-6 shadow-2xl">
        
        <!-- Left: VAMPIRE Branding -->
        <div class="flex flex-col justify-center leading-none select-none cursor-default group">
            <h1 class="text-2xl text-[#af0000] font-bold tracking-[0.2em] font-cinzel group-hover:text-[#ff0000] transition-colors shadow-black drop-shadow-md">VAMPIRE</h1>
            <span class="text-[0.6rem] text-[#d4af37] tracking-[0.3em] font-serif italic uppercase opacity-80 group-hover:opacity-100 transition-opacity">The Masquerade</span>
        </div>

        <!-- Center: Identity & File Controls (Grouped) -->
        <div class="flex items-center gap-4 bg-black/40 px-6 py-1.5 rounded-full border border-[#222]">
            <div class="flex items-center gap-2 group relative">
                <i class="fas fa-pen-nib text-gray-600 text-xs"></i>
                <input type="text" id="save-filename" value="Unnamed_Neonate" class="bg-transparent border-b border-transparent hover:border-[#333] focus:border-gold text-white font-bold text-sm w-32 focus:w-48 transition-all focus:outline-none placeholder-gray-600 text-center" title="Character File Name">
            </div>

            <button id="save-btn" class="text-gray-400 hover:text-white transition w-8 h-8 flex items-center justify-center rounded hover:bg-[#222]" title="Inscribe (Save)">
                <i class="fas fa-save"></i>
            </button>

            <div class="h-6 w-px bg-[#333]"></div>

            <div class="flex items-center gap-2">
                <select id="char-select" class="bg-transparent text-xs text-gray-400 border-none rounded px-2 py-1 w-24 focus:w-48 transition-all appearance-none cursor-pointer hover:text-white">
                    <option value="">-- Load --</option>
                </select>
                <button id="load-btn" class="text-gray-400 hover:text-white transition w-8 h-8 flex items-center justify-center rounded hover:bg-[#222]" title="Recall (Load)">
                    <i class="fas fa-folder-open"></i>
                </button>
            </div>
        </div>

        <!-- Right: Modes & Tools -->
        <div class="flex items-center gap-4">
            
            <!-- Freebie Toggle -->
            <button id="toggle-freebie-btn" class="flex items-center gap-2 px-3 py-1 rounded border border-[#333] hover:border-blue-500/50 hover:bg-blue-900/20 transition text-xs font-bold text-gray-400 disabled:opacity-30 disabled:cursor-not-allowed">
                <i class="fas fa-balance-scale"></i>
                <span id="freebie-btn-text">Freebies</span>
            </button>
            
            <div id="top-freebie-counter">
                <span id="f-total-top">0</span>/<input type="number" id="c-freebie-total" value="15" class="w-8 bg-transparent text-gold border-b border-[#333] text-center font-bold">
            </div>

            <!-- Play Mode Toggle -->
            <button id="play-mode-btn" class="flex items-center gap-2 px-3 py-1 rounded border border-[#d4af37] text-[#d4af37] hover:bg-[#d4af37] hover:text-black transition text-xs font-bold uppercase tracking-wider shadow-[0_0_10px_rgba(212,175,55,0.2)]">
                <i class="fas fa-gamepad"></i>
                <span id="play-btn-text">Play</span>
            </button>

            <div class="h-8 w-px bg-[#333]"></div>

            <!-- Tools Dropdown (Export/Import/Print) -->
            <div class="flex gap-2 text-gray-500">
                <button id="export-btn" class="hover:text-white w-8 h-8 rounded hover:bg-[#222] transition" title="Export JSON"><i class="fas fa-file-export"></i></button>
                <button id="import-trigger" class="hover:text-white w-8 h-8 rounded hover:bg-[#222] transition" title="Import JSON"><i class="fas fa-file-import"></i></button>
                <button id="print-btn" class="hover:text-white w-8 h-8 rounded hover:bg-[#222] transition" title="Print Sheet"><i class="fas fa-print"></i></button>
                <input type="file" id="import-input" class="hidden" accept=".json">
            </div>
        </div>
    </nav>

    <!-- Walkthrough Guide - Moved left to avoid right-nav overlap -->
    <div id="walkthrough-guide" class="fixed bottom-24 right-20 z-40 flex items-center gap-4 translate-y-20 opacity-0 pointer-events-none md:pointer-events-auto">
        <div id="guide-message" class="bg-black/90 border border-[#d4af37] text-[#f0e6d2] px-4 py-2 rounded text-xs font-bold shadow-lg w-48 text-right">
            Initialize Character...
        </div>
        <div id="guide-icon" class="w-12 h-12 rounded-full bg-[#af0000] border-2 border-[#d4af37] flex items-center justify-center shadow-[0_0_15px_rgba(175,0,0,0.6)] cursor-pointer transition-transform" onclick="window.nextStep()">
            <i class="fas fa-ankh text-white text-xl"></i>
        </div>
    </div>

    <!-- FREEBIE SIDEBAR -->
    <div id="freebie-sidebar">
        <div id="sb-toggle-btn" onclick="window.toggleSidebarLedger()">Ledger</div>
        <h3 class="heading text-gold text-sm border-b border-gold pb-2 mb-4 text-center">Freebie Ledger</h3>
        <div class="space-y-2 text-xs">
            <div class="cost-row"><span>Attributes (5/dot)</span><span id="sb-attr" class="cost-val">0</span></div>
            <div class="cost-row"><span>Abilities (2/dot)</span><span id="sb-abil" class="cost-val">0</span></div>
            <div class="cost-row"><span>Disciplines (7/dot)</span><span id="sb-disc" class="cost-val">0</span></div>
            <div class="cost-row"><span>Backgrounds (1/dot)</span><span id="sb-back" class="cost-val">0</span></div>
            <div class="cost-row"><span>Virtues (2/dot)</span><span id="sb-virt" class="cost-val">0</span></div>
            <div class="cost-row"><span>Humanity (2/dot)</span><span id="sb-human" class="cost-val">0</span></div>
            <div class="cost-row"><span>Willpower (1/dot)</span><span id="sb-will" class="cost-val">0</span></div>
            <div class="cost-row"><span>Merits (Cost)</span><span id="sb-merit" class="cost-val">0</span></div>
            <div class="cost-row"><span>Flaws (Bonus)</span><span id="sb-flaw" class="text-green-400 font-bold">0</span></div>
            <div class="mt-4 pt-2 border-t border-[#444] flex justify-between font-bold text-sm">
                <span>Remaining:</span>
                <span id="sb-total" class="text-green-400">15</span>
            </div>
        </div>
    </div>

    <div id="dice-tray" class="p-5">
        <div class="flex justify-between items-center mb-4 border-b border-[#444] pb-2">
            <h3 class="heading text-xs text-[#d4af37] uppercase tracking-widest font-bold">Dice Engine</h3>
            <button id="clear-pool-btn" class="text-[10px] text-gray-400 hover:text-white uppercase font-bold tracking-tighter" onclick="window.clearPool()">[ Clear Pool ]</button>
        </div>
        <div id="pool-display" class="text-[11px] text-gray-200 mb-3 italic font-medium">Select traits to build pool...</div>
        <div id="specialty-container" class="items-center gap-2 mb-4 px-3 py-2 bg-white/10 border border-white/20 rounded">
            <input type="checkbox" id="use-specialty" class="w-4 h-4 cursor-pointer">
            <label for="use-specialty" class="text-[10px] uppercase font-black text-white cursor-pointer tracking-tight">Specialty Applied (10s = 2 Successes)</label>
        </div>
        <div class="flex items-center gap-3 mb-5">
            <span class="text-[10px] uppercase font-black text-gray-300">Diff:</span>
            <input type="number" id="roll-diff" value="6" class="w-14 text-center !border !border-[#555] !bg-black !text-white !font-bold">
            <button id="roll-btn" class="flex-1 bg-[#8b0000] text-white text-[11px] py-3 uppercase font-black tracking-widest hover:bg-red-600 transition shadow-lg" onclick="window.rollPool()">Roll Pool</button>
        </div>
        <div id="roll-results" class="max-h-52 overflow-y-auto space-y-3"></div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div id="sheet-content" class="max-w-5xl mx-auto shadow-2xl bg-black/30 pb-20 border-x border-b border-[#222]">

        <nav id="sheet-nav" class="flex justify-center bg-black sticky top-0 z-40 border-b border-[#333]"></nav>
        
        <!-- HEADER MOVED TO NAV BAR - Spacer added -->
        <div class="mt-8 md:mt-12"></div>

        <div class="p-6 md:p-12">
            <!-- Phase 1 -->
            <div id="phase-1" class="step-container active">
                <div class="sheet-section !mt-0">
                    <div class="section-title">Character Concept</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="space-y-5">
                            <div><label class="label-text">Name</label><input type="text" id="c-name"></div>
                            <div><label class="label-text">Player</label><input type="text" id="c-player"></div>
                            <div><label class="label-text">Chronicle</label><input type="text" id="c-chronicle"></div>
                        </div>
                        <div class="space-y-5">
                            <div><label class="label-text">Nature</label><select id="c-nature"></select></div>
                            <div><label class="label-text">Demeanor</label><select id="c-demeanor"></select></div>
                            <div><label class="label-text">Concept</label><input type="text" id="c-concept"></div>
                        </div>
                        <div class="space-y-5">
                            <div><label class="label-text">Clan</label><select id="c-clan"></select></div>
                            <div><label class="label-text">Generation</label><input type="number" id="c-gen" value="13"></div>
                            <div><label class="label-text">Sire</label><input type="text" id="c-sire"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phase 2 -->
            <div id="phase-2" class="step-container">
                <div class="sheet-section !mt-0">
                    <div class="section-title">Step Two: Attributes</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                        <div id="list-attr-physical"><h3 class="column-title">Physical <span id="p-phys" class="pool-counter"></span></h3><div class="flex justify-center gap-2 mb-4 creation-only"><button data-cat="attr" data-group="Physical" data-v="7" class="prio-btn">7</button><button data-cat="attr" data-group="Physical" data-v="5" class="prio-btn">5</button><button data-cat="attr" data-group="Physical" data-v="3" class="prio-btn">3</button></div></div>
                        <div id="list-attr-social"><h3 class="column-title">Social <span id="p-social" class="pool-counter"></span></h3><div class="flex justify-center gap-2 mb-4 creation-only"><button data-cat="attr" data-group="Social" data-v="7" class="prio-btn">7</button><button data-cat="attr" data-group="Social" data-v="5" class="prio-btn">5</button><button data-cat="attr" data-group="Social" data-v="3" class="prio-btn">3</button></div></div>
                        <div id="list-attr-mental"><h3 class="column-title">Mental <span id="p-mental" class="pool-counter"></span></h3><div class="flex justify-center gap-2 mb-4 creation-only"><button data-cat="attr" data-group="Mental" data-v="7" class="prio-btn">7</button><button data-cat="attr" data-group="Mental" data-v="5" class="prio-btn">5</button><button data-cat="attr" data-group="Mental" data-v="3" class="prio-btn">3</button></div></div>
                    </div>
                </div>
            </div>

            <!-- Phase 3 -->
            <div id="phase-3" class="step-container">
                <div class="sheet-section !mt-0">
                    <div class="section-title">Step Three: Abilities</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                        <div class="flex flex-col h-full"><div id="list-abil-talents"><h3 class="column-title">Talents <span id="p-tal" class="pool-counter"></span></h3><div class="flex justify-center gap-2 mb-4 creation-only"><button data-cat="abil" data-group="Talents" data-v="13" class="prio-btn">13</button><button data-cat="abil" data-group="Talents" data-v="9" class="prio-btn">9</button><button data-cat="abil" data-group="Talents" data-v="5" class="prio-btn">5</button></div></div><div id="custom-talents" class="mt-auto pt-4 border-t border-[#333]"></div></div>
                        <div class="flex flex-col h-full"><div id="list-abil-skills"><h3 class="column-title">Skills <span id="p-ski" class="pool-counter"></span></h3><div class="flex justify-center gap-2 mb-4 creation-only"><button data-cat="abil" data-group="Skills" data-v="13" class="prio-btn">13</button><button data-cat="abil" data-group="Skills" data-v="9" class="prio-btn">9</button><button data-cat="abil" data-group="Skills" data-v="5" class="prio-btn">5</button></div></div><div id="custom-skills" class="mt-auto pt-4 border-t border-[#333]"></div></div>
                        <div class="flex flex-col h-full"><div id="list-abil-knowledges"><h3 class="column-title">Knowledges <span id="p-kno" class="pool-counter"></span></h3><div class="flex justify-center gap-2 mb-4 creation-only"><button data-cat="abil" data-group="Knowledges" data-v="13" class="prio-btn">13</button><button data-cat="abil" data-group="Knowledges" data-v="9" class="prio-btn">9</button><button data-cat="abil" data-group="Knowledges" data-v="5" class="prio-btn">5</button></div></div><div id="custom-knowledges" class="mt-auto pt-4 border-t border-[#333]"></div></div>
                    </div>
                </div>
            </div>

            <!-- Phase 4 -->
            <div id="phase-4" class="step-container">
                <div class="sheet-section !mt-0">
                    <div class="section-title">Step Four: Advantages</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                        <div><h3 class="column-title">Disciplines <span id="p-disc" class="pool-counter">[3]</span></h3><div id="list-disc" class="space-y-3 mt-2"></div></div>
                        <div><h3 class="column-title">Backgrounds <span id="p-back" class="pool-counter">[5]</span></h3><div id="list-back" class="space-y-3 mt-2"></div></div>
                        <div><h3 class="column-title">Virtues <span id="p-virt" class="pool-counter">[7]</span></h3><div id="list-virt" class="space-y-5 mt-2"></div></div>
                    </div>
                </div>
            </div>

            <!-- Phase 5 -->
            <div id="phase-5" class="step-container space-y-10">
                <div class="flex flex-col gap-8">
                    <div class="sheet-section !mt-0">
                        <div class="section-title">Background Descriptions</div>
                        <div id="social-profile-list" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6"></div>
                    </div>
                    
                    <div class="sheet-section">
                        <div class="section-title">Blood Bonds / Vinculi</div>
                        <div id="blood-bond-list" class="space-y-3 mt-4"></div>
                    </div>

                    <div class="sheet-section">
                        <div class="section-title">Possessions & Gear</div>
                        <div id="inventory-manager" class="p-2 space-y-4 border-b border-[#333] pb-4 mb-4">
                            <div class="flex flex-col gap-2 mb-2">
                                <label class="label-text">1. Select Item Type</label>
                                <select id="inv-type" class="w-full text-[11px] bg-[#111] border border-[#444] text-white p-2">
                                    <option value="Gear">General Gear</option>
                                    <option value="Weapon">Weapon</option>
                                    <option value="Armor">Armor</option>
                                    <option value="Vehicle">Vehicle</option>
                                </select>
                                
                                <div id="inv-base-wrapper" class="hidden">
                                    <label class="label-text">2. Choose Base Template (Auto-fills Stats)</label>
                                    <select id="inv-base-select" class="w-full text-[11px] bg-[#111] border border-[#444] text-white p-2"></select>
                                </div>

                                <div>
                                    <label class="label-text">3. Specific Description / Name (Optional)</label>
                                    <input type="text" id="inv-name" placeholder="e.g. 'Ceremonial Dagger' or 'Grandpa's Revolver'" class="w-full text-[11px] bg-transparent border-b border-[#444] text-white p-2">
                                </div>
                            </div>
                            
                            <div id="inv-stats-row" class="hidden grid grid-cols-5 gap-2">
                                <input type="text" id="inv-diff" placeholder="Diff" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-dmg" placeholder="Dmg" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-range" placeholder="Rng" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-rate" placeholder="Rate" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-clip" placeholder="Clip" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                            </div>

                            <div id="inv-armor-row" class="hidden grid grid-cols-2 gap-2">
                                <input type="text" id="inv-rating" placeholder="Rating" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-penalty" placeholder="Penalty" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                            </div>

                            <div id="inv-vehicle-row" class="hidden grid grid-cols-3 gap-2">
                                <input type="text" id="inv-safe" placeholder="Safe Spd" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-max" placeholder="Max Spd" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                                <input type="text" id="inv-man" placeholder="Maneuver" class="text-center text-[9px] bg-transparent border-b border-[#444] text-white">
                            </div>

                            <div class="flex justify-between items-center">
                                <div class="flex gap-2 items-center">
                                    <input type="checkbox" id="inv-carried" checked class="w-3 h-3">
                                    <label for="inv-carried" class="text-[9px] text-gray-400 uppercase">Carried</label>
                                </div>
                                <button id="add-inv-btn" class="bg-[#8b0000] px-4 py-2 text-[10px] font-bold text-white uppercase hover:bg-red-700 shadow-md">Add Item</button>
                            </div>
                        </div>

                        <!-- Distinct Spots for Possessions -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="column-title">Gear (Carried)</h3>
                                <div id="inv-list-carried" class="space-y-2 min-h-[50px]"></div>
                            </div>
                            <div>
                                <h3 class="column-title">Equipment (Owned)</h3>
                                <div id="inv-list-owned" class="space-y-2 min-h-[50px]"></div>
                            </div>
                        </div>

                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div>
                                <h3 class="column-title">Feeding Grounds</h3>
                                <textarea id="inv-feeding-grounds" class="h-24 w-full text-xs" placeholder="Describe your hunting grounds..."></textarea>
                            </div>
                             <div>
                                <h3 class="column-title">Vehicles</h3>
                                <div id="vehicle-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sheet-section"><div class="section-title">Havens</div><div id="multi-haven-list" class="space-y-6"></div></div>
                </div>
            </div>

            <!-- Phase 6 -->
            <div id="phase-6" class="step-container space-y-10">
                <div class="flex flex-col gap-10">
                    <div class="sheet-section !mt-0">
                        <div class="section-title">Merits & Flaws</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div>
                                <h3 class="column-title">Merits</h3>
                                <div class="text-xs text-center text-gray-500 mb-2 italic" id="merit-locked-msg">Enable Freebie Mode to edit Merits</div>
                                <div id="merits-list-create" class="space-y-3 mt-4"></div>
                            </div>
                            <div>
                                <h3 class="column-title">Flaws</h3>
                                <div class="text-xs text-center text-gray-500 mb-2 italic" id="flaw-locked-msg">Enable Freebie Mode to edit Flaws</div>
                                <div id="flaws-list-create" class="space-y-3 mt-4"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sheet-section">
                        <div class="section-title">Other Traits & Rituals</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div>
                                <h3 class="column-title">Traits</h3>
                                <div id="other-traits-rows-create" class="space-y-1 mt-4"></div>
                            </div>
                            <div>
                                <h3 class="column-title">Rituals</h3>
                                <div id="rituals-list-create" class="space-y-4"><textarea id="rituals-list-create-ta" class="w-full h-40" placeholder="List Rituals here..."></textarea></div>
                            </div>
                        </div>
                    </div>

                    <div class="sheet-section">
                        <div class="section-title">Combat Maneuvers & Weapons</div>
                        <div class="flex flex-col">
                            <div class="grid grid-cols-6 gap-2 text-[10px] uppercase text-gray-400 font-bold border-b border-[#555] pb-1 mb-2 text-center">
                                <div class="col-span-2 text-left pl-2">Attack</div>
                                <div>Diff</div>
                                <div>Dmg</div>
                                <div>Range</div>
                                <div>Clip</div>
                            </div>
                            <!-- Standard Maneuvers (Always Visible) -->
                            <div class="grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-gray-500">
                                <div class="col-span-2 text-left pl-2 font-bold text-white">Bite</div>
                                <div>5</div><div>Str+1(A)</div><div>-</div><div>-</div>
                            </div>
                            <div class="grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-gray-500">
                                <div class="col-span-2 text-left pl-2 font-bold text-white">Clinch</div>
                                <div>6</div><div>Str(B)</div><div>-</div><div>-</div>
                            </div>
                             <div class="grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-gray-500">
                                <div class="col-span-2 text-left pl-2 font-bold text-white">Grapple</div>
                                <div>6</div><div>Str(B)</div><div>-</div><div>-</div>
                            </div>
                            <div class="grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-gray-500">
                                <div class="col-span-2 text-left pl-2 font-bold text-white">Kick</div>
                                <div>7</div><div>Str+1(B)</div><div>-</div><div>-</div>
                            </div>
                            <div class="grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-gray-500">
                                <div class="col-span-2 text-left pl-2 font-bold text-white">Punch</div>
                                <div>6</div><div>Str(B)</div><div>-</div><div>-</div>
                            </div>
                             <div class="grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-gray-500">
                                <div class="col-span-2 text-left pl-2 font-bold text-white">Tackle</div>
                                <div>7</div><div>Str+1(B)</div><div>-</div><div>-</div>
                            </div>
                            
                            <!-- Dynamic Weapons from Inventory -->
                            <div id="combat-list-create" class="space-y-1 mt-2"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-6 mt-6 pt-4 border-t border-[#333] text-center">
                            <div><label class="label-text">Total Armor Rating</label><div id="total-armor-rating" class="text-lg font-bold text-white">0</div></div>
                            <div><label class="label-text">Total Penalty</label><div id="total-armor-penalty" class="text-lg font-bold text-red-400">0</div></div>
                            <div><label class="label-text">Active Armor</label><div id="active-armor-names" class="text-[9px] text-gray-400">None</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phase 7 -->
            <div id="phase-7" class="step-container space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="sheet-section !mt-0"><div class="section-title">Physical Appearance</div><div id="vitals-create-inputs" class="grid grid-cols-2 gap-4"></div><div class="mt-6"><label class="label-text">Description / Sketch Notes</label><textarea id="bio-desc" class="h-32"></textarea></div></div>
                    <div class="space-y-6"><div class="sheet-section !mt-0"><div class="section-title">Mental Traits & Goals</div><div class="space-y-4"><div><label class="label-text text-gold">Derangements</label><div id="derangements-list" class="space-y-2 mt-2"></div></div><div><label class="label-text text-gold">Languages</label><textarea id="bio-languages" class="h-20"></textarea></div><div><label class="label-text text-gold">Short-Term Goals</label><textarea id="bio-goals-st" class="h-20"></textarea></div><div><label class="label-text text-gold">Long-Term Goals</label><textarea id="bio-goals-lt" class="h-20"></textarea></div></div></div></div>
                </div>
            </div>

            <!-- Phase 8 -->
            <div id="phase-8" class="step-container space-y-10">
                <div class="sheet-section !mt-0">
                    <div class="section-title">Final Touches</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-8">
                            <div class="bg-black/30 p-6 border border-[#333]">
                                <label class="label-text block text-center mb-4 text-gold font-bold">Check Base Totals</label>
                                <div class="flex flex-col gap-6">
                                    <div class="flex justify-between items-center text-[11px] py-1">
                                        <div class="flex flex-col flex-1 mr-4">
                                            <label class="label-text text-gold">Humanity / Path</label>
                                            <select id="c-path-name-create" class="w-full text-xs bg-transparent border-b border-[#333] text-white p-1 appearance-none cursor-pointer">
                                                <!-- Populated by JS -->
                                            </select>
                                        </div>
                                        <div class="dot-row" id="phase8-humanity-dots"></div>
                                    </div>
                                    <div class="flex justify-between items-center text-[11px] py-1">
                                        <span class="trait-label uppercase">Willpower</span>
                                        <div class="dot-row" id="phase8-willpower-dots"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6"><div class="sheet-section !m-0"><div class="section-title">Final Character History</div><textarea id="char-history" class="w-full h-64" placeholder="Full Background History..."></textarea></div><button id="finalize-btn" class="w-full bg-[#af0000] text-white py-4 heading text-sm tracking-widest hover:bg-red-600 transition shadow-2xl font-black uppercase" onclick="window.togglePlayMode()">Finalize Character Log</button></div>
                    </div>
                </div>
            </div>

            <!-- Play Mode -->
            <div id="play-mode-1" class="step-container space-y-10">
                <div id="play-concept-row" class="grid grid-cols-3 gap-6 text-[11px] uppercase border-b border-[#333] pb-6 font-bold text-gold"></div>
                <div id="play-rows-container" class="space-y-10"><div id="play-row-attr" class="grid grid-cols-1 md:grid-cols-3 gap-10"></div><div id="play-row-abil" class="grid grid-cols-1 md:grid-cols-3 gap-10"></div><div id="play-row-adv" class="grid grid-cols-1 md:grid-cols-3 gap-10"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10 border-t border-[#333] pt-10"><div class="sheet-section"><div class="section-title">Humanity / Path</div><div class="flex flex-col items-center gap-4 py-2">
                    <select id="c-path-name" class="text-center text-gold font-bold uppercase tracking-widest !bg-transparent !border-b !border-[#333] mb-1 appearance-none cursor-pointer w-full text-sm">
                        <!-- Populated by JS -->
                    </select>
                    <div id="humanity-dots-play" class="flex justify-center"></div><div class="flex items-center gap-2 mt-2"><span class="label-text text-gray-500">Bearing:</span><input type="text" id="c-bearing-name" class="w-24 text-xs !border-b !border-[#333]"><input type="number" id="c-bearing-value" class="w-10 text-center text-xs !border-b !border-[#333]" placeholder="( )"></div></div></div><div class="sheet-section"><div class="section-title">Willpower</div><div id="willpower-dots-play" class="flex justify-center mb-2"></div><div id="willpower-boxes-play" class="flex justify-center"></div></div><div class="sheet-section"><div class="section-title">Blood Pool</div><div id="blood-boxes-play" class="grid grid-cols-10 gap-1.5 justify-center mt-2"></div></div><div class="sheet-section"><div class="section-title">Health</div><div id="health-chart-play" class="space-y-1.5"></div></div></div>
            </div>

            <div id="play-mode-2" class="step-container space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10"><div class="sheet-section !mt-0"><div class="section-title">Merits & Flaws</div><div id="merit-flaw-rows-play" class="space-y-2 text-white font-bold"></div></div><div class="sheet-section !mt-0"><div class="section-title">Other Traits</div><div id="other-traits-rows-play" class="space-y-1"></div><div class="mt-8 border-t border-[#333] pt-4"><div class="section-title">Rituals</div><div id="rituals-list-play" class="text-xs text-white whitespace-pre-wrap mt-2 p-2 bg-black/40 border border-[#333] min-h-[100px]"></div></div></div></div>
                <div class="sheet-section">
                    <div class="section-title">Combat Maneuvers</div>
                    <table class="w-full text-[11px] uppercase text-left mt-4 border-collapse">
                        <thead><tr class="border-b border-[#555] text-gray-400 font-bold"><th class="p-2">Weapon</th><th class="p-2">Diff</th><th class="p-2">Dmg</th><th class="p-2">Rng</th><th class="p-2">Rate</th><th class="p-2">Clip</th></tr></thead>
                        <tbody id="combat-rows-play"></tbody>
                    </table>
                    <div class="grid grid-cols-3 gap-6 mt-6 pt-4 border-t border-[#333] font-bold"><div><label class="label-text">Armor Rating</label><div id="armor-rating-play" class="text-white"></div></div><div><label class="label-text">Armor Penalty</label><div id="armor-penalty-play" class="text-white"></div></div><div><label class="label-text">Armor Desc</label><div id="armor-desc-play" class="text-xs text-gray-400 whitespace-pre-wrap"></div></div></div>
                </div>
            </div>

            <div id="play-mode-3" class="step-container space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="md:col-span-2 space-y-6"><div class="sheet-section !mt-0"><div class="section-title">Background Descriptions</div><div id="play-social-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4"></div></div><div class="sheet-section"><div class="section-title">Blood Bonds / Vinculi</div><div id="play-blood-bonds" class="space-y-2 mt-4 text-xs font-bold"></div></div></div><div class="space-y-6"><div class="sheet-section !mt-0"><div class="section-title">Possessions</div><div class="space-y-4 mt-2">
                    <div><label class="label-text text-gold">Gear (Carried)</label><div id="play-gear-carried" class="text-xs text-white whitespace-pre-wrap"></div></div>
                    <div><label class="label-text text-gold">Equipment (Owned)</label><div id="play-gear-owned" class="text-xs text-white whitespace-pre-wrap"></div></div>
                    <div><label class="label-text text-gold">Vehicles</label><div id="play-vehicles" class="space-y-2 font-bold text-white"></div></div>
                    <div><label class="label-text text-gold">Feeding Grounds</label><div id="play-feeding-grounds" class="text-xs text-white whitespace-pre-wrap"></div></div></div></div><div class="sheet-section"><div class="section-title">Havens</div><div id="play-havens-list" class="space-y-4 mt-2"></div></div></div></div>
            </div>

            <div id="play-mode-4" class="step-container space-y-10"><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="sheet-section !mt-0"><div class="section-title">Vitals</div><div id="play-vitals-list" class="space-y-3 py-2 text-[11px] uppercase font-bold text-white"></div><div class="mt-6 border-t border-[#333] pt-4"><label class="label-text text-gold">Physical Description</label><div id="play-bio-desc" class="text-xs text-gray-300 whitespace-pre-wrap"></div></div></div><div class="md:col-span-2 space-y-6"><div class="grid grid-cols-2 gap-6"><div class="sheet-section !mt-0"><div class="section-title">Derangements</div><div id="play-derangements" class="text-xs text-white p-2"></div></div><div class="sheet-section !mt-0"><div class="section-title">Languages</div><div id="play-languages" class="text-xs text-white p-2"></div></div></div><div class="sheet-section"><div class="section-title">Goals</div><div class="grid grid-cols-2 gap-6 mt-2"><div class="border-l-2 border-gold pl-4"><label class="label-text text-gold">Short-Term</label><div id="play-goals-st" class="text-xs text-gray-200 mt-1"></div></div><div class="border-l-2 border-gold pl-4"><label class="label-text text-gold">Long-Term</label><div id="play-goals-lt" class="text-xs text-gray-200 mt-1"></div></div></div></div><div class="sheet-section"><div class="section-title">Full History</div><div id="play-history" class="text-sm text-gray-300 whitespace-pre-wrap p-4"></div></div></div></div></div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase setup for Zeb
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'v20-neonate-sheet';

        const CLANS = ["Assamite", "Brujah", "Followers of Set", "Gangrel", "Giovanni", "Lasombra", "Malkavian", "Nosferatu", "Ravnos", "Toreador", "Tremere", "Tzimisce", "Ventrue", "Caitiff"];
        const ARCHETYPES = ["Architect", "Autocrat", "Bon Vivant", "Bravo", "Capitalist", "Caregiver", "Celebrant", "Chameleon", "Child", "Competitor", "Conformist", "Conniver", "Curmudgeon", "Dabbler", "Deviant", "Director", "Enigma", "Eye of the Storm", "Fanatic", "Gallant", "Guru", "Idealist", "Judge", "Loner", "Martyr", "Masochist", "Monster", "Pedagogue", "Penitent", "Perfectionist", "Rebel", "Rogue", "Sadist", "Scientist", "Sociopath", "Soldier", "Survivor", "Thrill-Seeker", "Traditionalist", "Trickster", "Visionary"];
        const ATTRIBUTES = { Physical: ["Strength", "Dexterity", "Stamina"], Social: ["Charisma", "Manipulation", "Appearance"], Mental: ["Perception", "Intelligence", "Wits"] };
        const ABILITIES = { Talents: ["Alertness", "Athletics", "Awareness", "Brawl", "Empathy", "Expression", "Intimidation", "Leadership", "Streetwise", "Subterfuge"], Skills: ["Animal Ken", "Crafts", "Drive", "Etiquette", "Firearms", "Larceny", "Melee", "Performance", "Stealth", "Survival"], Knowledges: ["Academics", "Computer", "Finance", "Investigation", "Law", "Medicine", "Occult", "Politics", "Science", "Technology"] };
        const BACKGROUNDS = ["Allies", "Alternate Identity", "Black Hand Membership", "Contacts", "Domain", "Fame", "Generation", "Herd", "Influence", "Mentor", "Resources", "Retainers", "Rituals", "Status"];
        const DISCIPLINES = ["Animalism", "Auspex", "Celerity", "Chimerstry", "Dementation", "Dominate", "Fortitude", "Necromancy", "Obfuscate", "Obtenebration", "Potence", "Presence", "Protean", "Quietus", "Serpentis", "Thaumaturgy", "Vicissitude"];
        const VIRTUES = ["Conscience", "Self-Control", "Courage"];
        const PATHS = ["Humanity", "Path of Blood", "Path of Bones", "Path of Caine", "Path of Cathari", "Path of the Feral Heart", "Path of the Honorable Accord", "Path of Lilith", "Path of Metamorphosis", "Path of Night", "Path of Paradox", "Path of Typhon"];
        const VIT = ["age", "app-age", "dob", "rip", "hair", "eyes", "race", "nat", "height", "weight", "sex"];
        const HEALTH_STATES = [{l: "Bruised", p: 0}, {l: "Hurt", p: -1}, {l: "Injured", p: -1}, {l: "Wounded", p: -2}, {l: "Mauled", p: -2}, {l: "Crippled", p: -5}, {l: "Incap", p: -99}];
        const GEN_LIMITS = { 15: {m:10,p:1}, 14: {m:10,p:1}, 13: {m:10,p:1}, 12: {m:11,p:1}, 11: {m:12,p:1}, 10: {m:13,p:1}, 9: {m:14,p:2}, 8: {m:15,p:3}, 7: {m:20,p:4}, 6: {m:30,p:6}, 5: {m:40,p:10}, 4: {m:50,p:15}, 3: {m:100,p:100} };
        
        const DERANGEMENTS = [
            "Amnesia", "Anxiety", "Bipolar Disorder", "Bulimia", "Fugue", "Hysteria", 
            "Megalomania", "Multiple Personalities", "Obsessive-Compulsive", 
            "Paranoia", "Phobia", "Schizophrenia", "Sanguinary Animism"
        ];

        const V20_MERITS_LIST = [
            { n: "Acute Sense", t: "Merit", v: 1 }, { n: "Ambidextrous", t: "Merit", v: 1 }, { n: "Catlike Balance", t: "Merit", v: 1 },
            { n: "Early Riser", t: "Merit", v: 1 }, { n: "Eat Food", t: "Merit", v: 1 }, { n: "Blush of Health", t: "Merit", v: 2 },
            { n: "Enchanting Voice", t: "Merit", v: 2 }, { n: "Daredevil", t: "Merit", v: 3 }, { n: "Efficient Digestion", t: "Merit", v: 3 },
            { n: "Huge Size", t: "Merit", v: 4 }, { n: "Prestigious Sire", t: "Merit", v: 1 }, { n: "Natural Leader", t: "Merit", v: 1 },
            { n: "Specific Interests", t: "Merit", v: 1 }, { n: "Harmless", t: "Merit", v: 1 }, { n: "Protege", t: "Merit", v: 1 },
            { n: "Rep", t: "Merit", v: 1 }, { n: "Language", t: "Merit", v: 1 }, { n: "Common Sense", t: "Merit", v: 1 },
            { n: "Concentration", t: "Merit", v: 1 }, { n: "Time Sense", t: "Merit", v: 1 }, { n: "Code of Honor", t: "Merit", v: 1 },
            { n: "Eidetic Memory", t: "Merit", v: 2 }, { n: "Light Sleeper", t: "Merit", v: 2 }, { n: "Calm Heart", t: "Merit", v: 3 },
            { n: "Iron Will", t: "Merit", v: 3 }, { n: "Medium", t: "Merit", v: 2 }, { n: "Magic Resistance", t: "Merit", v: 2 },
            { n: "Oracular Ability", t: "Merit", v: 3 }, { n: "Unbondable", t: "Merit", v: 3 }, { n: "Lucky", t: "Merit", v: 3 },
            { n: "True Faith", t: "Merit", v: 7 },
        ];

        const V20_FLAWS_LIST = [
            { n: "Deep Sleeper", t: "Flaw", v: 1 }, { n: "Intolerance", t: "Flaw", v: 1 }, { n: "Nightmare", t: "Flaw", v: 1 },
            { n: "Prey Exclusion", t: "Flaw", v: 1 }, { n: "Overconfident", t: "Flaw", v: 1 }, { n: "Shy", t: "Flaw", v: 1 },
            { n: "Soft-Hearted", t: "Flaw", v: 1 }, { n: "Speech Impediment", t: "Flaw", v: 1 }, { n: "Bad Sight", t: "Flaw", v: 2 },
            { n: "One Eye", t: "Flaw", v: 2 }, { n: "Short Fuse", t: "Flaw", v: 2 }, { n: "Vengeful", t: "Flaw", v: 2 },
            { n: "Amnesia", t: "Flaw", v: 2 }, { n: "Lunacy", t: "Flaw", v: 2 }, { n: "Phobia", t: "Flaw", v: 2 },
            { n: "Addiction", t: "Flaw", v: 3 }, { n: "Lame", t: "Flaw", v: 3 }, { n: "Deformity", t: "Flaw", v: 3 },
            { n: "Deaf", t: "Flaw", v: 4 }, { n: "Hunted", t: "Flaw", v: 4 }, { n: "Blind", t: "Flaw", v: 6 },
            { n: "Enemy", t: "Flaw", v: 1, range: "1-5", variable: true }, { n: "Dark Secret", t: "Flaw", v: 1, range: "1-5", variable: true },
            { n: "Cursed", t: "Flaw", v: 1, range: "1-5", variable: true }, { n: "Mistaken Identity", t: "Flaw", v: 1 },
            { n: "Beacon of the Unholy", t: "Flaw", v: 2 }, { n: "Death Sight", t: "Flaw", v: 2 }, { n: "Haunted", t: "Flaw", v: 3 },
            { n: "Flashbacks", t: "Flaw", v: 1, range: "1-2", variable: true }
        ];

        const V20_WEAPONS_LIST = [
            { n: "Sap / Blackjack", diff: 4, dmg: "Str+1(B)", range: "-", rate: "1", clip: "-" },
            { n: "Club / Bat", diff: 4, dmg: "Str+2(B)", range: "-", rate: "1", clip: "-" },
            { n: "Knife", diff: 4, dmg: "Str+1(L)", range: "-", rate: "1", clip: "-" },
            { n: "Sword", diff: 6, dmg: "Str+2(L)", range: "-", rate: "1", clip: "-" },
            { n: "Axe", diff: 7, dmg: "Str+3(L)", range: "-", rate: "1", clip: "-" },
            { n: "Stake", diff: 6, dmg: "Str+1(L)", range: "-", rate: "1", clip: "-" },
            { n: "Revolver, Lt", diff: 6, dmg: "4", range: "12", rate: "3", clip: "6" },
            { n: "Revolver, Hvy", diff: 7, dmg: "6", range: "35", rate: "2", clip: "6" },
            { n: "Pistol, Lt", diff: 6, dmg: "4", range: "20", rate: "4", clip: "17+1" },
            { n: "Pistol, Hvy", diff: 7, dmg: "5", range: "30", rate: "3", clip: "7+1" },
            { n: "Rifle", diff: 8, dmg: "8", range: "200", rate: "1", clip: "5+1" },
            { n: "SMG, Small", diff: 7, dmg: "4", range: "25", rate: "3", clip: "30+1" },
            { n: "SMG, Large", diff: 6, dmg: "6", range: "50", rate: "3", clip: "30+1" },
            { n: "Assault Rifle", diff: 7, dmg: "7", range: "150", rate: "3", clip: "30+1" },
            { n: "Shotgun", diff: 6, dmg: "8", range: "20", rate: "1", clip: "5+1" },
            { n: "Shotgun, Sawed-Off", diff: 7, dmg: "8", range: "10", rate: "2", clip: "2" }
        ];

        const V20_ARMOR_LIST = [
            { n: "Class I (Reinforced Clothing)", r: 1, p: 0 },
            { n: "Class II (Armor T-Shirt)", r: 2, p: 1 },
            { n: "Class III (Kevlar Vest)", r: 3, p: 1 },
            { n: "Class IV (Flak Jacket)", r: 4, p: 2 },
            { n: "Class V (Full Riot Gear)", r: 5, p: 3 }
        ];
        
        // V20 Core Rulebook p. 272 Vehicle Stats - Corrected to User Provided Chart
        const V20_VEHICLE_LIST = [
            { n: "6-Wheel Truck", safe: "60/95", max: "90/145", man: 3 },
            { n: "Tank (modern)", safe: "60/95", max: "100/160", man: 4 },
            { n: "Tank (WWII)", safe: "30/50", max: "40/65", man: 3 },
            { n: "Bus", safe: "60/95", max: "100/160", man: 3 },
            { n: "18-Wheeler", safe: "70/110", max: "110/175", man: 4 },
            { n: "Sedan", safe: "70/110", max: "120/195", man: 5 },
            { n: "Minivan", safe: "70/110", max: "120/195", man: 6 },
            { n: "Compact", safe: "70/110", max: "130/210", man: 6 },
            { n: "Sporty Compact", safe: "100/160", max: "140/225", man: 7 },
            { n: "Sport Coupe", safe: "110/175", max: "150/240", man: 8 },
            { n: "Sports Car", safe: "110/175", max: "160/255", man: 8 },
            { n: "Exotic Car", safe: "130/210", max: "190+/305+", man: 9 },
            { n: "Luxury Sedan", safe: "85/135", max: "155/250", man: 7 },
            { n: "Sport Sedan", safe: "85/135", max: "165/265", man: 8 },
            { n: "Midsize", safe: "75/120", max: "125/200", man: 6 },
            { n: "SUV/ Crossover", safe: "70/110", max: "115/185", man: 6 },
            { n: "Formula One Racer", safe: "140/225", max: "240/385", man: 10 }
        ];

        window.state = {
            isPlayMode: false, freebieMode: false, activePool: [], currentPhase: 1, furthestPhase: 1,
            dots: { attr: {}, abil: {}, disc: {}, back: {}, virt: {}, other: {} },
            prios: { attr: {}, abil: {} },
            status: { humanity: 7, willpower: 5, health: 0, blood: 0 },
            socialExtras: {}, textFields: {}, havens: [], bloodBonds: [], vehicles: [], customAbilityCategories: {},
            derangements: [],
            merits: [],
            flaws: [],
            inventory: [] 
        };

        let user = null;
        
        // Helper to safely set text, avoiding null errors
        const setSafeText = (id, val) => {
            const el = document.getElementById(id);
            if(el) el.innerText = val;
        };

        function syncInputs() {
            document.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(el => {
                if (el.id && !el.id.startsWith('inv-') && !el.id.startsWith('merit-') && !el.id.startsWith('flaw-') && !el.closest('.combat-row')) window.state.textFields[el.id] = el.value;
            });
        }

        function hydrateInputs() {
            Object.entries(window.state.textFields || {}).forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (el) el.value = val;
            });
        }

        function showNotification(msg) {
            const el = document.getElementById('notification');
            if (el) { el.innerText = msg; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 3000); }
        }

        function renderDots(count, max = 5) {
            let h = ''; for(let i=1; i<=max; i++) h += `<span class="dot ${i <= count ? 'filled' : ''}" data-v="${i}"></span>`;
            return h;
        }

        function renderBoxes(count, checked = 0, type = '') {
            let h = ''; for(let i=1; i<=count; i++) h += `<span class="box ${i <= checked ? 'checked' : ''}" data-v="${i}" data-type="${type}"></span>`;
            return h;
        }

        function clearPool() {
            window.state.activePool = [];
            document.querySelectorAll('.trait-label').forEach(el => el.classList.remove('selected'));
            setSafeText('pool-display', "Select traits to build pool...");
            document.getElementById('dice-tray').classList.remove('open');
        }
        window.clearPool = clearPool;

        function rollPool() {
            const poolSize = window.state.activePool.reduce((a,b) => a + b.val, 0);
            if (poolSize <= 0) { showNotification("Pool Empty"); return; }
            
            const diff = parseInt(document.getElementById('roll-diff').value) || 6;
            const isSpec = document.getElementById('use-specialty').checked;
            
            let results = [];
            let ones = 0;
            let rawSuccesses = 0;
            let hasSpec10 = false;

            for(let i=0; i<poolSize; i++) {
                const die = Math.floor(Math.random() * 10) + 1;
                results.push(die);
                if (die === 1) ones++;
                if (die >= diff) {
                    if (isSpec && die === 10) { rawSuccesses += 2; hasSpec10 = true; } else { rawSuccesses += 1; }
                }
            }

            let net = rawSuccesses - ones;
            let outcome = "";
            let outcomeClass = "";

            if (rawSuccesses === 0 && ones > 0) { outcome = "BOTCH"; outcomeClass = "dice-botch"; } 
            else if (net <= 0) { outcome = "FAILURE"; outcomeClass = "text-gray-400"; } 
            else { outcome = `${net} SUCCESS${net > 1 ? 'ES' : ''}`; outcomeClass = "dice-success"; }

            const tray = document.getElementById('roll-results');
            const row = document.createElement('div');
            row.className = 'bg-black/60 p-2 border border-[#333] text-[10px] mb-2 animate-in fade-in slide-in-from-right-4 duration-300';
            
            const diceRender = results.map(d => {
                let c = 'text-gray-500';
                if (d === 1) c = 'text-[#ff0000] font-bold';
                else if (d >= diff) {
                    c = 'text-[#d4af37] font-bold';
                    if (d === 10 && isSpec) c = 'text-[#4ade80] font-black text-xs';
                }
                return `<span class="${c}">${d}</span>`;
            }).join(' ');

            row.innerHTML = `<div class="flex justify-between border-b border-[#444] pb-1 mb-1"><span class="text-gray-400">Diff ${diff}${isSpec ? '*' : ''}</span><span class="${outcomeClass} font-black text-sm">${outcome}</span></div><div class="tracking-widest">${diceRender}</div>`;
            tray.insertBefore(row, tray.firstChild);
        }
        window.rollPool = rollPool;

        function calculateTotalFreebiesSpent(tempState = window.state) {
             let attrDots = 0; Object.keys(ATTRIBUTES).forEach(cat => ATTRIBUTES[cat].forEach(a => attrDots += (tempState.dots.attr[a] || 1)));
             // Corrected: 9 Base dots + 15 Creation dots (7/5/3) = 24 dots total allowed before freebies
             const attrCost = Math.max(0, attrDots - 24) * 5;

             let abilDots = 0;
             Object.keys(ABILITIES).forEach(cat => {
                 ABILITIES[cat].forEach(a => abilDots += (tempState.dots.abil[a] || 0));
                 if (tempState.customAbilityCategories) {
                     Object.entries(tempState.customAbilityCategories).forEach(([name, c]) => {
                         if (c === cat && tempState.dots.abil[name]) abilDots += tempState.dots.abil[name];
                     });
                 }
             });
             const abilCost = Math.max(0, abilDots - 27) * 2;

             let discDots = Object.values(tempState.dots.disc || {}).reduce((a,b)=>a+b,0);
             const discCost = Math.max(0, discDots - 3) * 7;

             let backDots = Object.values(tempState.dots.back || {}).reduce((a,b)=>a+b,0);
             const backCost = Math.max(0, backDots - 5) * 1;

             let virtDots = VIRTUES.reduce((a,v) => a + (tempState.dots.virt[v] || 1), 0);
             const virtCost = Math.max(0, virtDots - 10) * 2;

             const bH = (tempState.dots.virt && tempState.dots.virt.Conscience ? tempState.dots.virt.Conscience : 1) + 
                        (tempState.dots.virt && tempState.dots.virt["Self-Control"] ? tempState.dots.virt["Self-Control"] : 1);
             const bW = (tempState.dots.virt && tempState.dots.virt.Courage ? tempState.dots.virt.Courage : 1);
             
             // Use current status values, defaulting to base if undefined
             const curH = tempState.status.humanity !== undefined ? tempState.status.humanity : bH;
             const curW = tempState.status.willpower !== undefined ? tempState.status.willpower : bW;
             
             // Calculate cost based on points above base
             const humCost = Math.max(0, curH - bH) * 2;
             const willCost = Math.max(0, curW - bW) * 1;

             let mfCost = 0, mfBonus = 0;
             if (tempState.merits) tempState.merits.forEach(m => mfCost += (parseInt(m.val) || 0));
             if (tempState.flaws) tempState.flaws.forEach(f => mfBonus += (parseInt(f.val) || 0));
             
             const cappedBonus = Math.min(mfBonus, 7);
             return (attrCost + abilCost + discCost + backCost + virtCost + humCost + willCost + mfCost) - cappedBonus;
        }

        // --- NEW WALKTHROUGH & VALIDATION LOGIC ---

        const STEPS_CONFIG = [
            { id: 1, icon: 'fa-id-card', label: 'Concept', msg: 'Define your Identity' },
            { id: 2, icon: 'fa-hand-fist', label: 'Attributes', msg: 'Assign Attribute Points' },
            { id: 3, icon: 'fa-graduation-cap', label: 'Abilities', msg: 'Assign Ability Points' },
            { id: 4, icon: 'fa-bolt', label: 'Advantages', msg: 'Select Advantages' },
            { id: 5, icon: 'fa-users', label: 'Social', msg: 'Detail Backgrounds' },
            { id: 6, icon: 'fa-box-open', label: 'Gear', msg: 'Manage Inventory' },
            { id: 7, icon: 'fa-brain', label: 'Bio', msg: 'Flesh out History' },
            { id: 8, icon: 'fa-check-circle', label: 'Finish', msg: 'Finalize Character' }
        ];

        function checkStepComplete(step) {
            syncInputs();
            const s = window.state;

            // Ensure structures exist to prevent errors
            if (!s.prios) s.prios = { attr: {}, abil: {} };
            if (!s.dots) s.dots = { attr: {}, abil: {}, disc: {}, back: {}, virt: {} };

            if (step === 1) {
                // Check essential text fields
                return !!(s.textFields['c-name'] && s.textFields['c-nature'] && s.textFields['c-demeanor'] && s.textFields['c-clan']);
            }
            
            if (step === 2) {
                // ATTRIBUTES: 7/5/3 Validation
                // 1. Check if all 3 priorities are assigned
                const prios = Object.values(s.prios.attr || {});
                if (prios.length !== 3) return false; 
                // Double check they are the correct set
                if (!prios.includes(7) || !prios.includes(5) || !prios.includes(3)) return false;

                // 2. Check if spent EXACTLY
                return ['Physical', 'Social', 'Mental'].every(cat => {
                    const limit = s.prios.attr[cat] || 0;
                    let spent = 0;
                    ATTRIBUTES[cat].forEach(a => {
                        // Attributes start at 1 free dot. We count dots added BEYOND the first.
                        const val = parseInt(s.dots.attr[a] || 1);
                        spent += (val - 1);
                    });
                    return spent === limit;
                });
            }
            
            if (step === 3) {
                // ABILITIES: 13/9/5 Validation
                const prios = Object.values(s.prios.abil || {});
                if (prios.length !== 3) return false;
                if (!prios.includes(13) || !prios.includes(9) || !prios.includes(5)) return false;

                return ['Talents', 'Skills', 'Knowledges'].every(cat => {
                    const limit = s.prios.abil[cat] || 0;
                    let spent = 0;
                    
                    // Sum standard abilities
                    ABILITIES[cat].forEach(a => {
                        spent += parseInt(s.dots.abil[a] || 0);
                    });
                    
                    // Sum custom abilities assigned to this category
                    if (s.customAbilityCategories) {
                        Object.entries(s.customAbilityCategories).forEach(([name, c]) => {
                            if (c === cat) spent += parseInt(s.dots.abil[name] || 0);
                        });
                    }
                    
                    return spent === limit;
                });
            }
            
            if (step === 4) {
                // ADVANTAGES: Disciplines(3), Backgrounds(5), Virtues(7)
                // Strict V20 Creation Rules require exact spending.
                
                const discSpent = Object.values(s.dots.disc || {}).reduce((a, b) => a + parseInt(b||0), 0);
                const backSpent = Object.values(s.dots.back || {}).reduce((a, b) => a + parseInt(b||0), 0);
                
                // Virtues start at 1 each. We have 7 dots to add.
                // 3 Virtues * 1 base = 3. Total should be 3 + 7 = 10 dots total.
                const virtTotal = VIRTUES.reduce((a, v) => a + parseInt(s.dots.virt[v] || 1), 0);
                
                return discSpent === 3 && backSpent === 5 && virtTotal === 10;
            }
            
            // Steps 5-7 are descriptive and always technically "valid" to pass if user desires
            return true;
        }

        function updateWalkthrough() {
            if (window.state.isPlayMode) {
                document.getElementById('walkthrough-guide').classList.add('opacity-0', 'pointer-events-none');
                return;
            } else {
                document.getElementById('walkthrough-guide').classList.remove('opacity-0', 'pointer-events-none');
            }

            const current = window.state.currentPhase;
            const furthest = window.state.furthestPhase || 1;
            const isComplete = checkStepComplete(current);
            const msgEl = document.getElementById('guide-message');
            const iconEl = document.getElementById('guide-icon');
            const stepData = STEPS_CONFIG.find(s => s.id === current);

            if (current < furthest) {
                msgEl.innerText = `Return to Step ${furthest}`;
                msgEl.className = "bg-gray-900/90 border border-gray-500 text-gray-300 px-4 py-2 rounded text-xs font-bold shadow-lg w-48 text-right";
                iconEl.classList.add('ready'); // Always ready to jump forward
            } else {
                // At the frontier
                if (isComplete) {
                    msgEl.innerText = "Step Complete! Next >>";
                    msgEl.className = "bg-green-900/90 border border-green-500 text-green-100 px-4 py-2 rounded text-xs font-bold shadow-lg w-48 text-right";
                    iconEl.classList.add('ready');
                } else {
                    msgEl.innerText = stepData ? stepData.msg : "Continue...";
                    msgEl.className = "bg-black/90 border border-[#d4af37] text-[#f0e6d2] px-4 py-2 rounded text-xs font-bold shadow-lg w-48 text-right";
                    iconEl.classList.remove('ready');
                }
            }
        }
        window.updateWalkthrough = updateWalkthrough;

        function nextStep() {
            const current = window.state.currentPhase;
            const furthest = window.state.furthestPhase || 1;

            if (current < furthest) {
                // Jump to furthest
                changeStep(furthest);
            } else {
                // Try to advance
                if (checkStepComplete(current)) {
                    if (current < 8) {
                        changeStep(current + 1);
                    } else {
                        showNotification("Character Ready!");
                    }
                } else {
                    showNotification("Complete current step first!");
                }
            }
        }
        window.nextStep = nextStep;

        function checkCreationComplete() {
            return checkStepComplete(1) && checkStepComplete(2) && checkStepComplete(3) && checkStepComplete(4);
        }

        // --- END NEW LOGIC ---

        function updatePools() {
            if (!window.state.status) window.state.status = { humanity: 7, willpower: 5, health: 0, blood: 0 };
            
            // Derived Stats Sync
            if (!window.state.freebieMode && !window.state.isPlayMode) {
                const bH = (window.state.dots.virt?.Conscience || 1) + (window.state.dots.virt?.["Self-Control"] || 1);
                const bW = (window.state.dots.virt?.Courage || 1);
                window.state.status.humanity = bH;
                window.state.status.willpower = bW;
            }

            const curH = window.state.status.humanity;
            const curW = window.state.status.willpower;
            const gen = parseInt(document.getElementById('c-gen')?.value) || 13;
            const lim = GEN_LIMITS[gen] || GEN_LIMITS[13];

            // Counters
            Object.keys(ATTRIBUTES).forEach(cat => {
                let cs = 0; ATTRIBUTES[cat].forEach(a => cs += ((window.state.dots.attr[a] || 1) - 1));
                const elId = 'p-' + cat.toLowerCase().slice(0,4);
                const targetId = elId === 'p-soci' ? 'p-social' : elId === 'p-ment' ? 'p-mental' : elId;
                setSafeText(targetId, `[${Math.max(0, (window.state.prios.attr[cat] || 0) - cs)}]`);
            });

            Object.keys(ABILITIES).forEach(cat => {
                let cs = 0; ABILITIES[cat].forEach(a => cs += (window.state.dots.abil[a] || 0));
                if (window.state.customAbilityCategories) { Object.entries(window.state.customAbilityCategories).forEach(([name, c]) => { if (c === cat && window.state.dots.abil[name]) cs += window.state.dots.abil[name]; }); }
                setSafeText('p-' + cat.toLowerCase().slice(0,3), `[${Math.max(0, (window.state.prios.abil[cat] || 0) - cs)}]`);
            });
            
            const discSpent = Object.values(window.state.dots.disc || {}).reduce((a, b) => a + b, 0);
            setSafeText('p-disc', `[${Math.max(0, 3 - discSpent)}]`);
            const backSpent = Object.values(window.state.dots.back || {}).reduce((a, b) => a + b, 0);
            setSafeText('p-back', `[${Math.max(0, 5 - backSpent)}]`);
            const virtTotalDots = VIRTUES.reduce((a, v) => a + (window.state.dots.virt[v] || 1), 0);
            setSafeText('p-virt', `[${Math.max(0, 7 - (virtTotalDots - 3))}]`);

            // Freebie Calculations
            if (window.state.freebieMode) {
                 const totalSpent = calculateTotalFreebiesSpent(window.state);
                 setSafeText('f-total-top', totalSpent); // Update new top bar counter
                 
                 let attrDots = 0; Object.keys(ATTRIBUTES).forEach(cat => ATTRIBUTES[cat].forEach(a => attrDots += (window.state.dots.attr[a] || 1)));
                 const attrCost = Math.max(0, attrDots - 24) * 5;
                 setSafeText('sb-attr', attrCost);

                 let abilDots = 0; Object.keys(ABILITIES).forEach(cat => { ABILITIES[cat].forEach(a => abilDots += (window.state.dots.abil[a] || 0)); if (window.state.customAbilityCategories) { Object.entries(window.state.customAbilityCategories).forEach(([name, c]) => { if (c === cat && window.state.dots.abil[name]) abilDots += window.state.dots.abil[name]; }); } });
                 const abilCost = Math.max(0, abilDots - 27) * 2;
                 setSafeText('sb-abil', abilCost);

                 const discCost = Math.max(0, discSpent - 3) * 7;
                 setSafeText('sb-disc', discCost);
                 const backCost = Math.max(0, backSpent - 5) * 1;
                 setSafeText('sb-back', backCost);
                 const virtCost = Math.max(0, (virtTotalDots-3) - 7) * 2;
                 setSafeText('sb-virt', virtCost);
                 
                 const con = (window.state.dots.virt && window.state.dots.virt.Conscience ? window.state.dots.virt.Conscience : 1);
                 const self = (window.state.dots.virt && window.state.dots.virt["Self-Control"] ? window.state.dots.virt["Self-Control"] : 1);
                 const cou = (window.state.dots.virt && window.state.dots.virt.Courage ? window.state.dots.virt.Courage : 1);
                 
                 const bH = con + self;
                 const bW = cou;
                 
                 const curH = window.state.status.humanity !== undefined ? window.state.status.humanity : bH;
                 const curW = window.state.status.willpower !== undefined ? window.state.status.willpower : bW;

                 const humCost = Math.max(0, curH - bH) * 2;
                 setSafeText('sb-human', humCost);
                 
                 const willCost = Math.max(0, curW - bW) * 1;
                 setSafeText('sb-will', willCost);

                 let mfCost = 0, mfBonus = 0;
                 if (window.state.merits) window.state.merits.forEach(m => mfCost += (parseInt(m.val) || 0));
                 if (window.state.flaws) window.state.flaws.forEach(f => mfBonus += (parseInt(f.val) || 0));
                 const cappedBonus = Math.min(mfBonus, 7);

                 setSafeText('sb-merit', mfCost);
                 setSafeText('sb-flaw', `+${cappedBonus}`);
                 
                 const limit = parseInt(document.getElementById('c-freebie-total')?.value) || 15;
                 const remaining = limit - totalSpent;
                 setSafeText('sb-total', remaining);
                 document.getElementById('freebie-sidebar').classList.add('active'); 
            } else {
                 document.getElementById('freebie-sidebar').classList.remove('active');
            }

            const fbBtn = document.getElementById('toggle-freebie-btn');
            if (fbBtn) {
                const complete = checkCreationComplete();
                fbBtn.disabled = !complete;
                if (!complete && window.state.freebieMode) toggleFreebieMode(); 
            }

            // Render Phase 8 Dots safely
            const p8h = document.getElementById('phase8-humanity-dots');
            if(p8h) {
                p8h.innerHTML = renderDots(curH, 10);
                p8h.onclick = (e) => {
                    if (!window.state.freebieMode || !e.target.dataset.v) return;
                    setDots('Humanity', 'status', parseInt(e.target.dataset.v), 1, 10);
                };
            }
            const p8w = document.getElementById('phase8-willpower-dots');
            if(p8w) {
                p8w.innerHTML = renderDots(curW, 10);
                p8w.onclick = (e) => {
                    if (!window.state.freebieMode || !e.target.dataset.v) return;
                    setDots('Willpower', 'status', parseInt(e.target.dataset.v), 1, 10);
                };
            }

            // Render Play Mode Dots safely
            document.querySelectorAll('#humanity-dots-play').forEach(el => el.innerHTML = renderDots(curH, 10));
            document.querySelectorAll('#willpower-dots-play').forEach(el => el.innerHTML = renderDots(curW, 10));
            document.querySelectorAll('#willpower-boxes-play').forEach(el => el.innerHTML = renderBoxes(curW, window.state.status.willpower || 0, 'wp'));
            document.querySelectorAll('#blood-boxes-play').forEach(el => el.innerHTML = renderBoxes(lim.m, window.state.status.blood || 0, 'blood'));
            
            const healthCont = document.getElementById('health-chart-play');
            if(healthCont && healthCont.children.length === 0) {
                 HEALTH_STATES.forEach((h, i) => {
                    const d = document.createElement('div'); d.className = 'flex justify-between items-center text-[10px] uppercase border-b border-[#333] py-2 font-bold';
                    d.innerHTML = `<span>${h.l}</span><div class="flex gap-3"><span>${h.p !== 0 ? h.p : ''}</span><div class="box" data-v="${i+1}" data-type="health"></div></div>`;
                    healthCont.appendChild(d);
                });
            }

            document.querySelectorAll('#health-chart-play .box').forEach((box, i) => {
                box.classList.toggle('checked', i < window.state.status.health);
            });
            
            // Re-render Combat Table
            const cList = document.getElementById('combat-list-create');
            if(cList && window.state.inventory) {
                cList.innerHTML = '';
                window.state.inventory.filter(i => i.type === 'Weapon' && i.status === 'carried').forEach(w => {
                     let display = w.displayName || w.name;
                     const r = document.createElement('div');
                     r.className = "grid grid-cols-6 gap-2 text-[10px] border-b border-[#222] py-1 text-center text-white items-center";
                     r.innerHTML = `
                        <div class="col-span-2 text-left pl-2 font-bold text-gold truncate">${display}</div>
                        <div>${w.stats.diff}</div>
                        <div class="text-gold font-bold">${w.stats.dmg}</div>
                        <div>${w.stats.range}</div>
                        <div>${w.stats.clip}</div>
                     `;
                     cList.appendChild(r);
                });
                
                let totalArmor = 0; let totalPenalty = 0; let activeArmor = [];
                window.state.inventory.filter(i => i.type === 'Armor' && i.status === 'carried').forEach(a => {
                    totalArmor += parseInt(a.stats?.rating) || 0;
                    totalPenalty += parseInt(a.stats?.penalty) || 0;
                    activeArmor.push(a.displayName || a.name);
                });
                
                setSafeText('total-armor-rating', totalArmor);
                setSafeText('total-armor-penalty', totalPenalty);
                setSafeText('active-armor-names', activeArmor.length > 0 ? activeArmor.join(', ') : "None");
            }

            // Update Walkthrough Guide Status
            updateWalkthrough();
        }
        window.updatePools = updatePools;

        function setDots(name, type, val, min, max = 5) {
            if (window.state.isPlayMode) return;
            if (type === 'status') {
                if (!window.state.freebieMode) return;
                if (name === 'Humanity') window.state.status.humanity = val;
                else if (name === 'Willpower') window.state.status.willpower = val;
                if (calculateTotalFreebiesSpent(window.state) > (parseInt(document.getElementById('c-freebie-total')?.value) || 15)) { showNotification("Freebie Limit Exceeded!"); return; }
                updatePools(); return;
            }

            const currentVal = window.state.dots[type][name] || min;
            let newVal = val;
            if (val === currentVal) newVal = val - 1;
            if (newVal < min) newVal = min;
            
            if (window.state.freebieMode) {
                const tempState = JSON.parse(JSON.stringify(window.state));
                if (!tempState.dots[type]) tempState.dots[type] = {};
                tempState.dots[type][name] = newVal;
                
                const projectedCost = calculateTotalFreebiesSpent(tempState);
                const limit = parseInt(document.getElementById('c-freebie-total')?.value) || 15;
                if (projectedCost > limit) {
                    showNotification("Freebie Limit Exceeded!");
                    return;
                }
            } else {
                if (type === 'attr') {
                    let group = null;
                    Object.keys(ATTRIBUTES).forEach(k => { if(ATTRIBUTES[k].includes(name)) group = k; });
                    
                    if (group) {
                         const limit = window.state.prios.attr[group];
                         if (limit === undefined) { showNotification(`Select priority for ${group}!`); return; }
                         
                         let currentSpent = 0;
                         ATTRIBUTES[group].forEach(a => {
                             if (a !== name) {
                                 const v = window.state.dots.attr[a] || 1;
                                 currentSpent += (v - 1);
                             }
                         });
                         // Fix: newVal is total dots. Cost is (newVal - 1). 
                         if (currentSpent + (newVal - 1) > limit) { showNotification("Limit Exceeded!"); return; }
                    }
                }
                else if (type === 'abil') {
                    if (newVal > 3) { showNotification("Max 3 dots in Abilities during creation!"); return; }
                    let group = null;
                    Object.keys(ABILITIES).forEach(k => { if(ABILITIES[k].includes(name)) group = k; });
                    if (!group && window.state.customAbilityCategories && window.state.customAbilityCategories[name]) {
                        group = window.state.customAbilityCategories[name];
                    }

                    if (group) {
                        const limit = window.state.prios.abil[group];
                        if (limit === undefined) { showNotification(`Select priority for ${group}!`); return; }
                        
                        let currentSpent = 0;
                        ABILITIES[group].forEach(a => {
                            if (a !== name) currentSpent += (window.state.dots.abil[a] || 0);
                        });
                        // Add custom abilities in this group
                        if (window.state.customAbilityCategories) {
                             Object.keys(window.state.dots.abil).forEach(k => {
                                 if (k !== name && window.state.customAbilityCategories[k] === group) currentSpent += (window.state.dots.abil[k] || 0);
                             });
                        }

                        if (currentSpent + newVal > limit) { showNotification("Limit Exceeded!"); return; }
                    }
                }
                else if (type === 'disc') {
                    let currentSpent = 0;
                    Object.keys(window.state.dots.disc).forEach(d => {
                        if (d !== name) currentSpent += (window.state.dots.disc[d] || 0);
                    });
                    if (currentSpent + newVal > 3) { showNotification("Max 3 Creation Dots!"); return; }
                }
                else if (type === 'back') {
                    let currentSpent = 0;
                    Object.keys(window.state.dots.back).forEach(b => {
                        if (b !== name) currentSpent += (window.state.dots.back[b] || 0);
                    });
                    if (currentSpent + newVal > 5) { showNotification("Max 5 Creation Dots!"); return; }
                }
                else if (type === 'virt') {
                    let currentSpent = 0;
                    VIRTUES.forEach(v => {
                        if (v !== name) currentSpent += (window.state.dots.virt[v] || 1);
                    });
                    // Total dots = 3 base + 7 to spend = 10. 
                    if ((currentSpent + newVal) > 10) { showNotification("Max 7 Creation Dots!"); return; }
                }
            }

            window.state.dots[type][name] = newVal;
            
            // Auto Update Derived Stats
            if (type === 'virt' && !window.state.isPlayMode && !window.state.freebieMode) {
                 const con = window.state.dots.virt.Conscience || 1;
                 const self = window.state.dots.virt["Self-Control"] || 1;
                 const cou = window.state.dots.virt.Courage || 1;
                 
                 window.state.status.humanity = con + self;
                 window.state.status.willpower = cou;
            }

            document.querySelectorAll(`.dot-row[data-n="${name}"][data-t="${type}"]`).forEach(el => el.innerHTML = renderDots(newVal, max));
            updatePools();
        }

        // --- Inventory Logic Moved Up to Ensure Hoisting ---
        function renderInventoryList() {
            const listCarried = document.getElementById('inv-list-carried');
            const listOwned = document.getElementById('inv-list-owned');
            
            // Vehicles have their own display area now
            const listVehicles = document.getElementById('vehicle-list');
            
            if(listCarried) listCarried.innerHTML = '';
            if(listOwned) listOwned.innerHTML = '';
            if(listVehicles) listVehicles.innerHTML = '';
            
            if(!listCarried || !listOwned || !listVehicles) return;
            
            (window.state.inventory || []).forEach((item, idx) => {
                const d = document.createElement('div');
                d.className = "flex justify-between items-center bg-black/40 border border-[#333] p-1 text-[10px] mb-1";
                
                let displayName = item.displayName || item.name;
                // If it's a specific weapon, append base type for clarity
                if(item.type === 'Weapon' && item.baseType && item.baseType !== displayName) {
                    displayName += ` <span class="text-gray-500">[${item.baseType}]</span>`;
                }

                let details = "";
                if(item.type === 'Weapon') {
                    details = `<div class="text-gray-400 text-[9px] mt-0.5 ml-1">Diff:${item.stats.diff} Dmg:${item.stats.dmg} Rng:${item.stats.range}</div>`;
                } else if(item.type === 'Armor') {
                    details = `<div class="text-gray-400 text-[9px] mt-0.5 ml-1">Rating:${item.stats.rating} Penalty:${item.stats.penalty}</div>`;
                } else if(item.type === 'Vehicle') {
                    details = `<div class="text-gray-400 text-[9px] mt-0.5 ml-1">Safe:${item.stats.safe} Max:${item.stats.max} Man:${item.stats.man}</div>`;
                }
                
                const statusColor = item.status === 'carried' ? 'text-green-400' : 'text-gray-500';
                const statusLabel = item.status === 'carried' ? 'CARRIED' : 'OWNED';
                
                d.innerHTML = `
                    <div class="flex-1 overflow-hidden mr-2">
                        <div class="font-bold text-white uppercase truncate" title="${item.displayName || item.name}">${displayName}</div>
                        ${details}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${item.type !== 'Vehicle' ? `<button class="${statusColor} font-bold text-[8px] border border-[#333] px-1 hover:bg-[#222]" onclick="window.toggleInvStatus(${idx})">${statusLabel}</button>` : ''}
                        <button class="text-red-500 font-bold px-1 hover:text-red-300" onclick="window.removeInventory(${idx})">&times;</button>
                    </div>
                `;
                
                if (item.type === 'Vehicle') {
                     listVehicles.appendChild(d);
                } else {
                    if (item.status === 'carried') {
                        listCarried.appendChild(d);
                    } else {
                        listOwned.appendChild(d);
                    }
                }
            });
            updatePools(); // To refresh combat table
        }
        
        window.removeInventory = (idx) => {
            window.state.inventory.splice(idx, 1);
            renderInventoryList();
        };
        
        window.toggleInvStatus = (idx) => {
            const item = window.state.inventory[idx];
            item.status = item.status === 'carried' ? 'owned' : 'carried';
            renderInventoryList();
        };

        window.renderInventoryList = renderInventoryList;
        // --- End Inventory Logic ---

        function renderRow(contId, label, type, min, max = 5) {
            const cont = typeof contId === 'string' ? document.getElementById(contId) : contId;
            if (!cont) return;
            const val = window.state.dots[type][label] || min;
            const div = document.createElement('div'); div.className = 'flex justify-between items-center text-[11px] py-1';
            div.innerHTML = `<span class="trait-label uppercase">${label}</span><div class="dot-row" data-n="${label}" data-t="${type}">${renderDots(val, max)}</div>`;
            div.querySelector('.trait-label').onclick = () => { if(window.state.isPlayMode) handleTraitClick(label, type); };
            div.querySelector('.dot-row').onclick = (e) => { if (e.target.dataset.v) setDots(label, type, parseInt(e.target.dataset.v), min, max); };
            cont.appendChild(div);
        }
        window.renderRow = renderRow;

        function handleTraitClick(name, type) {
            const val = window.state.dots[type][name] || 0;
            const existingIdx = window.state.activePool.findIndex(p => p.name === name);
            if (existingIdx > -1) window.state.activePool.splice(existingIdx, 1);
            else { if (window.state.activePool.length >= 2) window.state.activePool.shift(); window.state.activePool.push({name, val}); }
            document.querySelectorAll('.trait-label').forEach(el => el.classList.toggle('selected', window.state.activePool.some(p => p.name === el.innerText)));
            const display = document.getElementById('pool-display');
            if (window.state.activePool.length > 0) {
                setSafeText('pool-display', window.state.activePool.map(p => `${p.name} (${p.val})`).join(' + '));
                document.getElementById('dice-tray').classList.add('open');
            } else { window.clearPool(); }
        }

        async function saveCharacter() {
            if (!user) { showNotification("Authentication required"); return; }
            const filename = document.getElementById('save-filename').value.trim();
            if (!filename) return showNotification("Filename required");
            syncInputs();
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'characters', filename);
                await setDoc(docRef, { ...window.state, lastSaved: Date.now() });
                showNotification("Inscribed.");
                await refreshList();
            } catch (e) { showNotification("Save Error."); console.error(e); }
        }
        window.saveCharacter = saveCharacter;

        async function loadCharacter() {
            const name = document.getElementById('char-select').value;
            if (!name || !user) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'characters', name);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    window.state = snap.data();
                    // Backwards compatibility for furthestPhase
                    if (!window.state.furthestPhase) window.state.furthestPhase = 1;
                    
                    hydrateInputs();
                    updatePools();
                    showNotification("Recalled.");
                    // Re-render Dynamic Rows
                    const mList = document.getElementById('merits-list-create');
                    if(mList) { mList.innerHTML = ''; renderDynamicTraitRow('merits-list-create', 'Merit', V20_MERITS_LIST); }
                    const fList = document.getElementById('flaws-list-create');
                    if(fList) { fList.innerHTML = ''; renderDynamicTraitRow('flaws-list-create', 'Flaw', V20_FLAWS_LIST); }
                    
                    renderInventoryList();
                    
                    if (window.state.isPlayMode) { togglePlayMode(); togglePlayMode(); }
                    
                    // Restore to furthest phase
                    window.changeStep(window.state.furthestPhase || 1);
                }
            } catch (e) { showNotification("Recall Error."); }
        }
        window.loadCharacter = loadCharacter;

        async function refreshList() {
            if (!user) return;
            const snap = await getDocs(collection(db, 'artifacts', appId, 'users', user.uid, 'characters'));
            const sel = document.getElementById('char-select');
            sel.innerHTML = '<option value="">-- Load --</option>';
            snap.forEach(d => { const opt = document.createElement('option'); opt.value = d.id; opt.innerText = d.id; sel.appendChild(opt); });
        }

        function renderDynamicTraitRow(containerId, type, list) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Rebuild rows from state first
            const stateArray = type === 'Merit' ? (window.state.merits || []) : (window.state.flaws || []);
            
            // Clear container
            container.innerHTML = '';

            // Helper to append a single row
            const appendRow = (data = null) => {
                const row = document.createElement('div'); row.className = 'flex gap-2 items-center mb-2 trait-row';
                
                let options = `<option value="">-- Select ${type} --</option>`;
                list.forEach(item => {
                    const rangeText = item.range ? `(${item.range}pt)` : `(${item.v}pt)`;
                    options += `<option value="${item.n}" data-val="${item.v}" data-var="${item.variable||false}">${item.n} ${rangeText}</option>`;
                });
                options += '<option value="Custom">-- Custom / Write-in --</option>';

                row.innerHTML = `
                    <div class="flex-1 relative">
                        <select class="w-full text-[11px] font-bold uppercase bg-[#111] text-white border-b border-[#444]">${options}</select>
                        <input type="text" placeholder="Custom Name..." class="hidden w-full text-[11px] font-bold uppercase border-b border-[#444] bg-transparent text-white">
                    </div>
                    <input type="number" class="w-10 text-center text-[11px] !border !border-[#444] font-bold" min="1">
                    <div class="remove-btn">&times;</div>
                `;
                
                container.appendChild(row);

                const selectEl = row.querySelector('select');
                const textEl = row.querySelector('input[type="text"]');
                const numEl = row.querySelector('input[type="number"]');
                const removeBtn = row.querySelector('.remove-btn');

                const isLocked = !window.state.freebieMode;
                selectEl.disabled = isLocked;
                textEl.disabled = isLocked;
                numEl.disabled = isLocked;
                if(isLocked) {
                    selectEl.classList.add('opacity-50', 'cursor-not-allowed');
                    textEl.classList.add('opacity-50', 'cursor-not-allowed');
                    numEl.classList.add('opacity-50', 'cursor-not-allowed');
                }

                if (data) {
                    const exists = list.some(l => l.n === data.name);
                    if (exists) {
                        selectEl.value = data.name;
                        numEl.value = data.val;
                        const itemData = list.find(l => l.n === data.name);
                        if (itemData && !itemData.variable) {
                            numEl.disabled = true; 
                            numEl.classList.add('opacity-50');
                        }
                    } else {
                        selectEl.value = "Custom";
                        selectEl.classList.add('hidden');
                        textEl.classList.remove('hidden');
                        textEl.value = data.name;
                        numEl.value = data.val;
                    }
                } else {
                    numEl.value = "";
                    removeBtn.style.visibility = 'hidden'; 
                }

                const syncState = () => {
                    const allRows = container.querySelectorAll('.trait-row');
                    const newState = [];
                    allRows.forEach(r => {
                        const s = r.querySelector('select');
                        const t = r.querySelector('input[type="text"]');
                        const n = r.querySelector('input[type="number"]');
                        
                        let name = s.value === 'Custom' ? t.value : s.value;
                        let val = parseInt(n.value) || 0;
                        
                        if (name && name !== 'Custom') {
                            newState.push({ name, val });
                        }
                    });
                    
                    if (type === 'Merit') window.state.merits = newState;
                    else window.state.flaws = newState;
                    
                    updatePools();
                };

                selectEl.addEventListener('change', (e) => {
                    if (selectEl.value === 'Custom') {
                        selectEl.classList.add('hidden');
                        textEl.classList.remove('hidden');
                        textEl.focus();
                        numEl.value = 1;
                        numEl.disabled = false;
                        numEl.classList.remove('opacity-50');
                    } else if (selectEl.value) {
                        const opt = selectEl.options[selectEl.selectedIndex];
                        const baseVal = opt.dataset.val;
                        const isVar = opt.dataset.var === "true";
                        
                        numEl.value = baseVal;
                        
                        if (!isVar) {
                            numEl.disabled = true;
                            numEl.classList.add('opacity-50');
                        } else {
                            numEl.disabled = false;
                            numEl.classList.remove('opacity-50');
                        }
                        
                        if (row === container.lastElementChild) {
                            removeBtn.style.visibility = 'visible';
                            appendRow(); 
                        }
                    } else {
                        numEl.value = "";
                        numEl.disabled = false;
                    }
                    syncState();
                });

                textEl.addEventListener('blur', () => {
                    if (textEl.value === "") {
                        textEl.classList.add('hidden');
                        selectEl.classList.remove('hidden');
                        selectEl.value = "";
                    } else {
                        if (row === container.lastElementChild) {
                            removeBtn.style.visibility = 'visible';
                            appendRow(); 
                        }
                    }
                    syncState();
                });

                numEl.addEventListener('change', syncState);

                removeBtn.addEventListener('click', () => {
                    row.remove();
                    syncState();
                });
            };

            if (stateArray.length > 0) {
                stateArray.forEach(d => appendRow(d));
                appendRow(); 
            } else {
                appendRow();
            }
        }

        // Inventory UI Setup
        const invType = document.getElementById('inv-type');
        const invName = document.getElementById('inv-name');
        const invBaseWrapper = document.getElementById('inv-base-wrapper');
        const invBaseSelect = document.getElementById('inv-base-select');
        const statsRow = document.getElementById('inv-stats-row');
        const armorRow = document.getElementById('inv-armor-row');
        const vehicleRow = document.getElementById('inv-vehicle-row');
        const addBtn = document.getElementById('add-inv-btn');

        if(invType) {
            const updateFormState = () => {
                const t = invType.value;
                if(t === 'Weapon') {
                    invBaseWrapper.classList.remove('hidden');
                    let wOpts = `<option value="">-- Choose Base Type --</option>`;
                    V20_WEAPONS_LIST.forEach(w => wOpts += `<option value="${w.n}" data-diff="${w.diff}" data-dmg="${w.dmg}" data-range="${w.range}" data-rate="${w.rate}" data-clip="${w.clip}">${w.n}</option>`);
                    invBaseSelect.innerHTML = wOpts;
                    
                    statsRow.classList.remove('hidden');
                    armorRow.classList.add('hidden');
                    vehicleRow.classList.add('hidden');
                } else if(t === 'Armor') {
                    invBaseWrapper.classList.remove('hidden');
                    let aOpts = `<option value="">-- Choose Armor Class --</option>`;
                    V20_ARMOR_LIST.forEach(a => aOpts += `<option value="${a.n}" data-rating="${a.r}" data-penalty="${a.p}">${a.n}</option>`);
                    invBaseSelect.innerHTML = aOpts;

                    statsRow.classList.add('hidden');
                    armorRow.classList.remove('hidden');
                    vehicleRow.classList.add('hidden');
                } else if(t === 'Vehicle') {
                    invBaseWrapper.classList.remove('hidden');
                    let vOpts = `<option value="">-- Choose Vehicle Type --</option>`;
                    V20_VEHICLE_LIST.forEach(v => vOpts += `<option value="${v.n}" data-safe="${v.safe}" data-max="${v.max}" data-man="${v.man}">${v.n}</option>`);
                    invBaseSelect.innerHTML = vOpts;

                    statsRow.classList.add('hidden');
                    armorRow.classList.add('hidden');
                    vehicleRow.classList.remove('hidden');
                } else {
                    invBaseWrapper.classList.add('hidden');
                    statsRow.classList.add('hidden');
                    armorRow.classList.add('hidden');
                    vehicleRow.classList.add('hidden');
                }
                invBaseSelect.value = "";
                invName.value = ""; 
                document.querySelectorAll('#inv-stats-row input, #inv-armor-row input, #inv-vehicle-row input').forEach(i => i.value = "");
            };

            updateFormState();
            invType.addEventListener('change', updateFormState);

            invBaseSelect.addEventListener('change', () => {
                const t = invType.value;
                
                const placeholders = {
                    "Knife": "e.g. Switchblade, Bowie Knife",
                    "Sword": "e.g. Katana, Claymore",
                    "Sap / Blackjack": "e.g. Heavy book, Sock with coins",
                    "Club / Bat": "e.g. Baseball Bat, Tire Iron",
                    "Pistol, Lt": "e.g. Glock 17, Beretta 92",
                    "Pistol, Hvy": "e.g. .44 Magnum, Desert Eagle",
                    "Rifle": "e.g. Hunting Rifle, Sniper Rifle",
                    "Shotgun": "e.g. Pump-action, Double-barrel",
                    "Class I (Reinforced Clothing)": "e.g. Leather Jacket, Biker Gear",
                    "Class II (Armor T-Shirt)": "e.g. Ballistic Tee",
                    "Class III (Kevlar Vest)": "e.g. Police Vest",
                    "Class V (Full Riot Gear)": "e.g. SWAT Gear",
                    "Compact": "e.g. Honda Civic",
                    "Sedan": "e.g. Ford Taurus",
                    "Sports Car": "e.g. Porsche 911",
                    "Motorcycle": "e.g. Harley-Davidson",
                    "SUV/ Crossover": "e.g. Jeep Grand Cherokee"
                };

                if(invBaseSelect.value) {
                    const opt = invBaseSelect.options[invBaseSelect.selectedIndex];
                    const baseName = invBaseSelect.value;
                    
                    if (placeholders[baseName]) {
                        invName.placeholder = placeholders[baseName];
                    } else {
                        invName.placeholder = `e.g. Custom name for ${baseName}`;
                    }

                    if(t === 'Weapon') {
                        document.getElementById('inv-diff').value = opt.dataset.diff;
                        document.getElementById('inv-dmg').value = opt.dataset.dmg;
                        document.getElementById('inv-range').value = opt.dataset.range;
                        document.getElementById('inv-rate').value = opt.dataset.rate;
                        document.getElementById('inv-clip').value = opt.dataset.clip;
                    } else if(t === 'Armor') {
                        document.getElementById('inv-rating').value = opt.dataset.rating;
                        document.getElementById('inv-penalty').value = opt.dataset.penalty;
                    } else if(t === 'Vehicle') {
                        document.getElementById('inv-safe').value = opt.dataset.safe;
                        document.getElementById('inv-max').value = opt.dataset.max;
                        document.getElementById('inv-man').value = opt.dataset.man;
                    }
                }
            });

            addBtn.addEventListener('click', () => {
                const type = invType.value;
                let specificName = invName.value.trim();
                let baseType = invBaseSelect.value;
                let finalName = specificName || baseType; 
                let stats = {};

                if (type !== 'Gear' && !baseType && !specificName) {
                }
                if (!finalName) return showNotification("Enter a name or select a type.");

                if(type === 'Weapon') {
                    stats = {
                        diff: document.getElementById('inv-diff').value,
                        dmg: document.getElementById('inv-dmg').value,
                        range: document.getElementById('inv-range').value,
                        rate: document.getElementById('inv-rate').value,
                        clip: document.getElementById('inv-clip').value
                    };
                } else if(type === 'Armor') {
                    stats = {
                        rating: document.getElementById('inv-rating').value || 0,
                        penalty: document.getElementById('inv-penalty').value || 0
                    };
                } else if(type === 'Vehicle') {
                    stats = {
                        safe: document.getElementById('inv-safe').value || 0,
                        max: document.getElementById('inv-max').value || 0,
                        man: document.getElementById('inv-man').value || 0
                    };
                }

                if(!window.state.inventory) window.state.inventory = [];
                window.state.inventory.push({
                    name: baseType || finalName, 
                    displayName: finalName,      
                    baseType: baseType,          
                    type, 
                    stats,
                    status: document.getElementById('inv-carried').checked ? 'carried' : 'owned'
                });

                invName.value = "";
                invBaseSelect.value = "";
                document.querySelectorAll('#inv-stats-row input, #inv-armor-row input, #inv-vehicle-row input').forEach(i => i.value = "");
                
                renderInventoryList();
            });
        }
        
        function renderDynamicAdvantageRow(containerId, type, list, isAbil = false) {
            const container = document.getElementById(containerId);
            if (!container) return;
            let category = null;
            if (containerId === 'custom-talents') category = 'Talents';
            else if (containerId === 'custom-skills') category = 'Skills';
            else if (containerId === 'custom-knowledges') category = 'Knowledges';

            const row = document.createElement('div'); row.className = 'flex flex-col gap-1 mb-2 advantage-row';
            const head = document.createElement('div'); head.className = 'flex justify-between items-center';
            let inputField;
            if (isAbil) { inputField = document.createElement('input'); inputField.type = 'text'; inputField.placeholder = "Write-in..."; inputField.className = 'flex-1 mr-4 text-[10px] font-bold uppercase !bg-black/20 !border-b !border-[#333]'; }
            else { inputField = document.createElement('select'); inputField.className = 'flex-1 mr-4 text-[11px] font-bold uppercase'; inputField.innerHTML = `<option value="">-- Choose ${type} --</option>` + list.map(item => `<option value="${item}">${item}</option>`).join(''); }
            const dotCont = document.createElement('div'); dotCont.className = 'dot-row'; dotCont.innerHTML = renderDots(0, 5);
            const removeBtn = document.createElement('div'); removeBtn.className = 'remove-btn'; removeBtn.innerHTML = '&times;';
            if (container.children.length === 0) removeBtn.style.visibility = 'hidden';
            let curName = "";
            const onUpdate = (newVal) => {
                if (curName && curName !== newVal) { 
                    const dots = window.state.dots[type][curName]; 
                    delete window.state.dots[type][curName]; 
                    if (window.state.customAbilityCategories && window.state.customAbilityCategories[curName]) delete window.state.customAbilityCategories[curName];
                    if (newVal) window.state.dots[type][newVal] = dots || 0; 
                }
                curName = newVal;
                if (newVal) { 
                    window.state.dots[type][newVal] = window.state.dots[type][newVal] || 0; 
                    dotCont.innerHTML = renderDots(window.state.dots[type][newVal], 5); 
                    if (category) { if (!window.state.customAbilityCategories) window.state.customAbilityCategories = {}; window.state.customAbilityCategories[newVal] = category; }
                    const all = container.querySelectorAll(isAbil ? 'input' : 'select'); 
                    if (all[all.length - 1].value !== "") renderDynamicAdvantageRow(containerId, type, list, isAbil); 
                }
                updatePools();
            };
            if (isAbil) inputField.onblur = (e) => onUpdate(e.target.value); else inputField.onchange = (e) => onUpdate(e.target.value);
            removeBtn.onclick = () => { if (curName) { delete window.state.dots[type][curName]; if (window.state.customAbilityCategories && window.state.customAbilityCategories[curName]) delete window.state.customAbilityCategories[curName]; } row.remove(); updatePools(); };
            dotCont.onclick = (e) => { 
                if (!curName || !e.target.dataset.v) return; 
                let val = parseInt(e.target.dataset.v);
                const currentVal = window.state.dots[type][curName] || 0;
                if (val === currentVal) val = val - 1;

                if (window.state.freebieMode) {
                    const tempState = JSON.parse(JSON.stringify(window.state));
                    if (!tempState.dots[type]) tempState.dots[type] = {};
                    tempState.dots[type][curName] = val;
                    if (calculateTotalFreebiesSpent(tempState) > (parseInt(document.getElementById('c-freebie-total')?.value) || 15)) {
                        showNotification("Freebie Limit Exceeded!"); return;
                    }
                } else {
                      if (category) {
                          // --- NEW CHECK: MAX 3 RULE FOR CUSTOM ABILITIES ---
                          if (val > 3) { showNotification("Max 3 dots in Abilities during creation!"); return; }

                          if (window.state.prios.abil[category] === undefined) { showNotification(`Select a priority for ${category} first!`); return; }
                          const limit = window.state.prios.abil[category];
                          let currentSpent = 0;
                          ABILITIES[category].forEach(t => currentSpent += (window.state.dots.abil[t] || 0));
                          if (window.state.customAbilityCategories) {
                              Object.keys(window.state.dots.abil).forEach(k => {
                                  if (k !== curName && window.state.customAbilityCategories[k] === category) currentSpent += (window.state.dots.abil[k] || 0);
                              });
                          }
                          if (currentSpent + val > limit) { showNotification("Limit exceeded!"); return; }
                      } else if (type === 'disc') {
                         const currentSpent = Object.values(window.state.dots.disc || {}).reduce((a,b)=>a+b,0) - (window.state.dots.disc[curName]||0);
                         if (currentSpent + val > 3) { showNotification("Max 3 Creation Dots for Disciplines!"); return; }
                      } else if (type === 'back') {
                         const currentSpent = Object.values(window.state.dots.back || {}).reduce((a,b)=>a+b,0) - (window.state.dots.back[curName]||0);
                         if (currentSpent + val > 5) { showNotification("Max 5 Creation Dots for Backgrounds!"); return; }
                      }
                }

                window.state.dots[type][curName] = val; 
                dotCont.innerHTML = renderDots(val, 5); 
                updatePools(); 
            };
            head.appendChild(inputField); head.appendChild(dotCont); head.appendChild(removeBtn);
            row.appendChild(head); container.appendChild(row);
        }

        function renderBloodBondRow() {
            const cont = document.getElementById('blood-bond-list'); if (!cont) return;
            const row = document.createElement('div'); row.className = 'flex gap-2 items-center border-b border-[#222] pb-2 advantage-row';
            row.innerHTML = `
                <select class="w-24 text-[10px] uppercase font-bold mr-2 border-b border-[#333] bg-transparent">
                    <option value="Bond">Bond</option>
                    <option value="Vinculum">Vinculum</option>
                </select>
                <input type="text" placeholder="Bound to..." class="flex-1 text-xs">
                <input type="number" placeholder="Lvl" class="w-10 text-center text-xs" min="1" max="3">
                <div class="remove-btn">&times;</div>
            `;
            const typeSel = row.querySelector('select');
            const nI = row.querySelector('input[type="text"]'); 
            const rI = row.querySelector('input[type="number"]'); 
            const del = row.querySelector('.remove-btn');
            
            if (cont.children.length === 0) del.style.visibility = 'hidden';
            
            const onUpd = () => {
                if (typeSel.value === 'Bond') {
                    rI.max = 3;
                    if(parseInt(rI.value) > 3) rI.value = 3;
                }
                if (typeSel.value === 'Vinculum') {
                    rI.max = 10;
                    if(parseInt(rI.value) > 10) rI.value = 10;
                }

                window.state.bloodBonds = Array.from(cont.querySelectorAll('.advantage-row')).map(r => ({ 
                    type: r.querySelector('select').value,
                    name: r.querySelector('input[type="text"]').value, 
                    rating: r.querySelector('input[type="number"]').value 
                })).filter(b => b.name);
                
                if (cont.lastElementChild === row && nI.value !== "") renderBloodBondRow();
                updatePools(); 
            };
            
            typeSel.onchange = onUpd;
            nI.onblur = onUpd;
            rI.onblur = onUpd;
            del.onclick = () => { row.remove(); onUpd(); };
            cont.appendChild(row);
        }

        // Render Derangements List
        function renderDerangementsList() {
            const cont = document.getElementById('derangements-list');
            if (!cont) return;
            cont.innerHTML = '';

            window.state.derangements.forEach((d, idx) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center text-xs text-white border-b border-[#333] py-1";
                row.innerHTML = `<span>${d}</span><span class="remove-btn text-red-500" onclick="window.removeDerangement(${idx})">&times;</span>`;
                cont.appendChild(row);
            });

            // Adder Row
            const addRow = document.createElement('div');
            addRow.className = "flex gap-2 mt-2";
            let options = `<option value="">+ Add Derangement</option>` + DERANGEMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
            addRow.innerHTML = `
                <select id="derangement-select" class="flex-1 text-[10px] uppercase font-bold bg-black/40 border border-[#444] text-white p-1">
                    ${options}
                    <option value="Custom">Custom...</option>
                </select>
                <input type="text" id="derangement-custom" class="hidden flex-1 text-[10px] bg-black/40 border border-[#444] text-white p-1" placeholder="Type name...">
                <button id="add-derangement-btn" class="bg-[#8b0000] text-white px-2 py-1 text-[10px] font-bold hover:bg-red-700">ADD</button>
            `;
            cont.appendChild(addRow);

            const sel = document.getElementById('derangement-select');
            const inp = document.getElementById('derangement-custom');
            const btn = document.getElementById('add-derangement-btn');

            sel.onchange = () => {
                if (sel.value === 'Custom') {
                    sel.classList.add('hidden');
                    inp.classList.remove('hidden');
                    inp.focus();
                }
            };

            btn.onclick = () => {
                let val = sel.value === 'Custom' ? inp.value : sel.value;
                if (val && val !== 'Custom') {
                    window.state.derangements.push(val);
                    renderDerangementsList();
                    updatePools(); 
                }
            };
        }
        
        window.removeDerangement = (idx) => {
            window.state.derangements.splice(idx, 1);
            renderDerangementsList();
            updatePools();
        };

        function renderDynamicHavenRow() {
            const cont = document.getElementById('multi-haven-list'); if (!cont) return;
            const row = document.createElement('div'); row.className = 'border-b border-[#222] pb-4 advantage-row';
            row.innerHTML = `<div class="flex justify-between items-center mb-2"><input type="text" placeholder="Haven Title..." class="flex-1 text-[10px] font-bold text-gold uppercase !border-b !border-[#333]"><div class="remove-btn">&times;</div></div><input type="text" placeholder="Location..." class="text-xs mb-2 !border-b !border-[#333]"><textarea class="h-16 text-xs" placeholder="Details..."></textarea>`;
            const nameIn = row.querySelectorAll('input')[0]; const locIn = row.querySelectorAll('input')[1]; const descIn = row.querySelector('textarea'); const del = row.querySelector('.remove-btn');
            
            if (cont.children.length === 0) del.style.visibility = 'hidden';
            
            const onUpd = () => {
                window.state.havens = Array.from(cont.querySelectorAll('.advantage-row')).map(r => ({
                    name: r.querySelectorAll('input')[0].value, 
                    loc: r.querySelectorAll('input')[1].value, 
                    desc: r.querySelector('textarea').value
                })).filter(h => h.name || h.loc);
                
                if (cont.lastElementChild === row && nameIn.value !== "") renderDynamicHavenRow();
                updatePools(); 
            };
            
            [nameIn, locIn, descIn].forEach(el => el.onblur = onUpd);
            del.onclick = () => { row.remove(); onUpd(); };
            cont.appendChild(row);
        }

        function renderSocialProfileDescription(containerId, name) {
            const cont = document.getElementById(containerId);
            if (!cont) return;
            const safeId = 'desc-' + name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const row = document.createElement('div'); 
            row.className = 'mb-4 pb-2 border-b border-[#222]';
            row.innerHTML = `<label class="label-text text-gold">${name}</label><textarea id="${safeId}" class="h-16 text-xs" placeholder="Identity details for ${name}..."></textarea>`;
            cont.appendChild(row);
        }

        function updateBackgroundDescriptions() {
            const cont = document.getElementById('social-profile-list');
            if (!cont) return;
            cont.innerHTML = '';
            
            let hasBackgrounds = false;

            if (window.state.dots.back) {
                Object.entries(window.state.dots.back).forEach(([name, val]) => {
                    if (val > 0) {
                        renderSocialProfileDescription('social-profile-list', name);
                        hasBackgrounds = true;
                    }
                });
            }

            if (!hasBackgrounds) {
                cont.innerHTML = `<div class="col-span-1 md:col-span-2 text-center text-gray-500 italic py-10">Select Backgrounds in the Advantages section to add descriptions here.</div>`;
            }

            hydrateInputs();
        }

        function changeStep(s) {
            if (!window.state.furthestPhase || s > window.state.furthestPhase) {
                if (s > (window.state.furthestPhase || 0)) window.state.furthestPhase = s;
            }

            document.querySelectorAll('.step-container').forEach(c => c.classList.remove('active'));
            const prefix = window.state.isPlayMode ? 'play-mode-' : 'phase-';
            const target = document.getElementById(prefix + s);
            if (target) { target.classList.add('active'); window.state.currentPhase = s; }
            
            if (s === 5) {
                updateBackgroundDescriptions();
            }

            const nav = document.getElementById('sheet-nav');
            if (nav) {
                nav.innerHTML = '';
                if (window.state.isPlayMode) {
                     const steps = ["Sheet", "Traits", "Social", "Biography"];
                     steps.forEach((text, i) => {
                        const it = document.createElement('div'); 
                        it.className = `nav-item ${window.state.currentPhase === (i+1) ? 'active' : ''}`;
                        // Use default 'fa-file' for generic play tabs or specific ones
                        const icons = ['fa-scroll', 'fa-fist-raised', 'fa-users', 'fa-book'];
                        it.innerHTML = `<i class="fas ${icons[i]}"></i><span>${text}</span>`;
                        it.onclick = () => window.changeStep(i+1); 
                        nav.appendChild(it);
                    });
                } else {
                    const furthest = window.state.furthestPhase || 1;
                    STEPS_CONFIG.forEach(step => {
                        const it = document.createElement('div');
                        let statusClass = '';
                        
                        // We rely on CSS classes now, not inline tailwind text colors
                        if (step.id === s) {
                            statusClass = 'active';
                        } else if (step.id < s) {
                            statusClass = 'completed';
                        } else if (step.id <= furthest) {
                            statusClass = 'unlocked';
                        } else {
                            statusClass = 'locked';
                        }

                        it.className = `nav-item ${statusClass}`;
                        // Simplified innerHTML - CSS handles the tooltip and colors
                        it.innerHTML = `<i class="fas ${step.icon}"></i><span>${step.label}</span>`;
                        it.onclick = () => { if (step.id <= furthest) window.changeStep(step.id); };
                        nav.appendChild(it);
                    });
                }
            }
            updatePools(); // Update guide
        }
        window.changeStep = changeStep;

        function toggleFreebieMode() {
             window.state.freebieMode = !window.state.freebieMode;
             document.body.classList.toggle('freebie-mode', window.state.freebieMode);
             
             // Updated to check for both the sidebar button and the new top bar button
             const fbBtn = document.getElementById('toggle-freebie-btn');
             const fbBtnText = document.getElementById('freebie-btn-text');
             if (fbBtnText) fbBtnText.innerText = window.state.freebieMode ? "Exit Freebies" : "Freebies";
             if (fbBtn) {
                 fbBtn.classList.toggle('bg-blue-900/40', window.state.freebieMode);
                 fbBtn.classList.toggle('border-blue-500', window.state.freebieMode);
                 fbBtn.classList.toggle('text-blue-200', window.state.freebieMode);
             }
             
             const mMsg = document.getElementById('merit-locked-msg');
             const fMsg = document.getElementById('flaw-locked-msg');
             if(mMsg) mMsg.style.display = window.state.freebieMode ? 'none' : 'block';
             if(fMsg) fMsg.style.display = window.state.freebieMode ? 'none' : 'block';

             renderDynamicTraitRow('merits-list-create', 'Merit', V20_MERITS_LIST);
             renderDynamicTraitRow('flaws-list-create', 'Flaw', V20_FLAWS_LIST);
             
             updatePools(); 
        }
        window.toggleFreebieMode = toggleFreebieMode;

        function toggleSidebarLedger() {
            document.getElementById('freebie-sidebar').classList.toggle('open');
        }
        window.toggleSidebarLedger = toggleSidebarLedger;

        function togglePlayMode() {
            window.state.isPlayMode = !window.state.isPlayMode;
            document.body.classList.toggle('play-mode', window.state.isPlayMode);
            
            const pBtn = document.getElementById('play-mode-btn');
            const pBtnText = document.getElementById('play-btn-text');
            if(pBtnText) pBtnText.innerText = window.state.isPlayMode ? "Edit" : "Play";
            
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (['save-filename', 'char-select', 'roll-diff', 'use-specialty', 'c-path-name', 'c-path-name-create', 'c-bearing-name', 'c-bearing-value'].includes(el.id)) return;
                el.disabled = window.state.isPlayMode;
            });

            if (window.state.isPlayMode) {
                const row = document.getElementById('play-concept-row');
                if (row) row.innerHTML = `<div><span class="label-text">Name:</span> <span class="text-white font-bold">${document.getElementById('c-name').value}</span></div><div><span class="label-text">Nature:</span> <span class="text-white font-bold">${document.getElementById('c-nature').value}</span></div><div><span class="label-text">Clan:</span> <span class="text-white font-bold">${document.getElementById('c-clan').value}</span></div><div><span class="label-text">Player:</span> <span class="text-white font-bold">${document.getElementById('c-player').value}</span></div><div><span class="label-text">Demeanor:</span> <span class="text-white font-bold">${document.getElementById('c-demeanor').value}</span></div><div><span class="label-text">Generation:</span> <span class="text-white font-bold">${document.getElementById('c-gen').value}</span></div>`;

                const ra = document.getElementById('play-row-attr'); ra.innerHTML = '';
                Object.entries(ATTRIBUTES).forEach(([c,l]) => { const s = document.createElement('div'); s.className='sheet-section !mt-0'; s.innerHTML=`<div class="column-title">${c}</div>`; l.forEach(a=>renderRow(s,a,'attr',1)); ra.appendChild(s); });
                const rb = document.getElementById('play-row-abil'); rb.innerHTML = '';
                Object.entries(ABILITIES).forEach(([c,l]) => { const s = document.createElement('div'); s.className='sheet-section !mt-0'; s.innerHTML=`<div class="column-title">${c}</div>`; l.forEach(a=>renderRow(s,a,'abil',0)); rb.appendChild(s); });
                const rc = document.getElementById('play-row-adv'); rc.innerHTML = '';
                const ds = document.createElement('div'); ds.className='sheet-section !mt-0'; ds.innerHTML='<div class="column-title">Disciplines</div>';
                Object.entries(window.state.dots.disc).forEach(([n,v]) => { if(v>0) renderRow(ds,n,'disc',0); }); rc.appendChild(ds);
                const bs = document.createElement('div'); bs.className='sheet-section !mt-0'; bs.innerHTML='<div class="column-title">Backgrounds</div>';
                Object.entries(window.state.dots.back).forEach(([n,v]) => { if(v>0) renderRow(bs,n,'back',0); }); rc.appendChild(bs);
                const vs = document.createElement('div'); vs.className='sheet-section !mt-0'; vs.innerHTML='<div class="column-title">Virtues</div>';
                VIRTUES.forEach(v => renderRow(vs, v, 'virt', 1)); rc.appendChild(vs);

                const pg = document.getElementById('play-social-grid'); if(pg) {
                    pg.innerHTML = '';
                    BACKGROUNDS.forEach(s => {
                        const dots = window.state.dots.back[s] || 0; 
                        const safeId = 'desc-' + s.toLowerCase().replace(/[^a-z0-9]/g, '-');
                        const el = document.getElementById(safeId);
                        const txt = el ? el.value : "";
                        if(dots || txt) pg.innerHTML += `<div class="border-l-2 border-[#333] pl-4 mb-4"><div class="flex justify-between items-center"><label class="label-text text-gold">${s}</label><div class="text-[8px] font-bold text-white">${renderDots(dots,5)}</div></div><div class="text-xs text-gray-200 mt-1">${txt || "No description."}</div></div>`;
                    });
                }
                const pb = document.getElementById('play-blood-bonds'); if(pb) {
                    pb.innerHTML = '';
                    window.state.bloodBonds.forEach(b => { 
                        const label = b.type === 'Bond' ? (b.rating == 3 ? 'Full Bond' : `Drink ${b.rating}`) : `Vinculum ${b.rating}`;
                        pb.innerHTML += `<div class="flex justify-between border-b border-[#222] py-1 text-xs"><span>${b.name}</span><span class="text-gold font-bold">${label}</span></div>`; 
                    });
                }

                const mf = document.getElementById('merit-flaw-rows-play'); if(mf) {
                    mf.innerHTML = '';
                    if(window.state.merits) window.state.merits.forEach(m => {
                        mf.innerHTML += `<div class="flex justify-between text-xs py-1 border-b border-[#222]"><span>${m.name}</span><span class="text-red-400 font-bold">${m.val}</span></div>`; 
                    });
                    if(window.state.flaws) window.state.flaws.forEach(f => {
                        mf.innerHTML += `<div class="flex justify-between text-xs py-1 border-b border-[#222]"><span>${f.name}</span><span class="text-green-400 font-bold">${f.val}</span></div>`; 
                    });
                }
                
                const ot = document.getElementById('other-traits-rows-play'); if(ot) {
                    ot.innerHTML = '';
                    Object.entries(window.state.dots.other).forEach(([n,v]) => { if(v>0) renderRow(ot, n, 'other', 0); });
                }
                
                const plv = document.getElementById('play-vitals-list'); if(plv) {
                    plv.innerHTML = '';
                    VIT.forEach(v => { const val = document.getElementById('bio-' + v)?.value; if(val) plv.innerHTML += `<div class="flex justify-between border-b border-[#222] py-1 font-bold"><span class="text-gray-400">${v.replace('-',' ')}:</span> <span>${val}</span></div>`; });
                }
                
                const cp = document.getElementById('combat-rows-play'); if(cp) {
                    cp.innerHTML = '';
                    const standards = [
                        {n:'Bite',diff:5,dmg:'Str+1(A)'}, {n:'Clinch',diff:6,dmg:'Str(B)'}, {n:'Grapple',diff:6,dmg:'Str(B)'},
                        {n:'Kick',diff:7,dmg:'Str+1(B)'}, {n:'Punch',diff:6,dmg:'Str(B)'}, {n:'Tackle',diff:7,dmg:'Str+1(B)'}
                    ];
                    standards.forEach(s => {
                         const r = document.createElement('tr'); r.className='border-b border-[#222] text-[10px] text-gray-500';
                         r.innerHTML = `<td class="p-2 font-bold text-white">${s.n}</td><td class="p-2">${s.diff}</td><td class="p-2">${s.dmg}</td><td class="p-2">-</td><td class="p-2">-</td><td class="p-2">-</td>`;
                         cp.appendChild(r);
                    });
                    
                    if(window.state.inventory) {
                        window.state.inventory.filter(i => i.type === 'Weapon' && i.status === 'carried').forEach(w => {
                            let display = w.displayName || w.name;
                            const r = document.createElement('tr'); 
                            r.className='border-b border-[#222] text-[10px]'; 
                            r.innerHTML = `<td class="p-2 font-bold text-gold">${display}</td><td class="p-2 text-white">${w.stats.diff}</td><td class="p-2 text-white">${w.stats.dmg}</td><td class="p-2">${w.stats.range}</td><td class="p-2">${w.stats.rate}</td><td class="p-2">${w.stats.clip}</td>`; 
                            cp.appendChild(r);
                        });
                    }
                }

                if(document.getElementById('rituals-list-play')) document.getElementById('rituals-list-play').innerText = document.getElementById('rituals-list-create-ta').value;
                
                let carried = [];
                let owned = [];
                if(window.state.inventory) {
                    window.state.inventory.forEach(i => {
                        const str = `${i.displayName || i.name} ${i.type === 'Armor' ? `(R:${i.stats.rating} P:${i.stats.penalty})` : ''}`;
                        if(i.status === 'carried') carried.push(str); else owned.push(str);
                    });
                }
                
                setSafeText('play-gear-carried', carried.join(', '));
                setSafeText('play-gear-owned', owned.join(', '));
                
                if(document.getElementById('play-bio-desc')) document.getElementById('play-bio-desc').innerText = document.getElementById('bio-desc').value;
                
                if(document.getElementById('play-derangements')) {
                    const pd = document.getElementById('play-derangements');
                    pd.innerHTML = window.state.derangements.length > 0 ? 
                        window.state.derangements.map(d => `<div> ${d}</div>`).join('') : 
                        '<span class="text-gray-500 italic">None</span>';
                }
                
                if(document.getElementById('play-languages')) document.getElementById('play-languages').innerText = document.getElementById('bio-languages').value;
                if(document.getElementById('play-goals-st')) document.getElementById('play-goals-st').innerText = document.getElementById('bio-goals-st').value;
                if(document.getElementById('play-goals-lt')) document.getElementById('play-goals-lt').innerText = document.getElementById('bio-goals-lt').value;
                if(document.getElementById('play-history')) document.getElementById('play-history').innerText = document.getElementById('char-history').value;
                
                const feedSrc = document.getElementById('inv-feeding-grounds');
                if (feedSrc) setSafeText('play-feeding-grounds', feedSrc.value);
                
                if(document.getElementById('armor-rating-play')) {
                    let totalA = 0; let totalP = 0; let names = [];
                    if(window.state.inventory) {
                        window.state.inventory.filter(i => i.type === 'Armor' && i.status === 'carried').forEach(a => {
                            totalA += parseInt(a.stats?.rating)||0; totalP += parseInt(a.stats?.penalty)||0; names.push(a.displayName || a.name);
                        });
                    }
                    setSafeText('armor-rating-play', totalA);
                    setSafeText('armor-penalty-play', totalP);
                    setSafeText('armor-desc-play', names.join(', '));
                }

                if (document.getElementById('play-vehicles')) {
                    const pv = document.getElementById('play-vehicles');
                    pv.innerHTML = '';
                    if (window.state.inventory) {
                         window.state.inventory.filter(i => i.type === 'Vehicle').forEach(v => {
                            let display = v.displayName || v.name;
                            pv.innerHTML += `
                            <div class="mb-2 border-b border-[#333] pb-1">
                                <div class="font-bold text-white uppercase text-[10px]">${display}</div>
                                <div class="text-[9px] text-gray-400">Safe:${v.stats.safe} | Max:${v.stats.max} | Man:${v.stats.man}</div>
                            </div>`;
                         });
                    }
                }

                if (document.getElementById('play-havens-list')) {
                    const ph = document.getElementById('play-havens-list');
                    ph.innerHTML = '';
                    window.state.havens.forEach(h => { ph.innerHTML += `<div class="border-l-2 border-gold pl-4 mb-4"><div class="flex justify-between"><div><div class="font-bold text-white uppercase text-[10px]">${h.name}</div><div class="text-[9px] text-gold italic">${h.loc}</div></div></div><div class="text-xs text-gray-400 mt-1">${h.desc}</div></div>`; });
                }
            }
            window.changeStep(1);
            updatePools();
        }
        window.togglePlayMode = togglePlayMode;

        // Button Listeners
        document.getElementById('toggle-freebie-btn').onclick = window.toggleFreebieMode;

        document.getElementById('clear-pool-btn').onclick = window.clearPool;
        document.getElementById('roll-btn').onclick = rollPool;
        document.getElementById('save-btn').onclick = saveCharacter;
        document.getElementById('load-btn').onclick = loadCharacter;
        document.getElementById('play-mode-btn').onclick = togglePlayMode;
        document.getElementById('finalize-btn').onclick = togglePlayMode;
        document.getElementById('export-btn').onclick = () => { syncInputs(); const b = new Blob([JSON.stringify(window.state)], {type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`${document.getElementById('save-filename').value}.json`; a.click(); };
        document.getElementById('import-trigger').onclick = () => document.getElementById('import-input').click();
        document.getElementById('import-input').onchange = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload=(ev)=>{ window.state=JSON.parse(ev.target.result); hydrateInputs(); updatePools(); showNotification("Imported."); }; r.readAsText(f); } };
        document.getElementById('print-btn').onclick = () => window.print();

        document.body.addEventListener('click', (e) => {
            if (!window.state.isPlayMode) return;
            const box = e.target.closest('.box');
            if (!box) return;
            const type = box.dataset.type;
            const val = parseInt(box.dataset.v);
            if (type === 'wp') window.state.status.willpower = (val === 1 && window.state.status.willpower === 1) ? 0 : val;
            else if (type === 'blood') window.state.status.blood = (val === 1 && window.state.status.blood === 1) ? 0 : val;
            else if (type === 'health') window.state.status.health = (val === 1 && window.state.status.health === 1) ? 0 : val;
            updatePools();
        });

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                document.getElementById('loading-overlay').style.display = 'none';
                const ns = document.getElementById('c-nature'), ds = document.getElementById('c-demeanor'), cs = document.getElementById('c-clan');
                ARCHETYPES.sort().forEach(a => { ns.add(new Option(a,a)); ds.add(new Option(a,a)); });
                CLANS.sort().forEach(c => cs.add(new Option(c,c)));

                const ps1 = document.getElementById('c-path-name');
                const ps2 = document.getElementById('c-path-name-create');
                PATHS.forEach(p => {
                    if(ps1) ps1.add(new Option(p,p));
                    if(ps2) ps2.add(new Option(p,p));
                });
                
                if(ps1) ps1.addEventListener('change', (e) => {
                    if(ps2) ps2.value = e.target.value;
                    if(window.state.textFields) window.state.textFields['c-path-name'] = e.target.value;
                });
                if(ps2) ps2.addEventListener('change', (e) => {
                    if(ps1) ps1.value = e.target.value;
                    if(window.state.textFields) window.state.textFields['c-path-name'] = e.target.value;
                });

                Object.keys(ATTRIBUTES).forEach(c => ATTRIBUTES[c].forEach(a => { window.state.dots.attr[a] = 1; renderRow('list-attr-'+c.toLowerCase(), a, 'attr', 1); }));
                Object.keys(ABILITIES).forEach(c => ABILITIES[c].forEach(a => { window.state.dots.abil[a] = 0; renderRow('list-abil-'+c.toLowerCase(), a, 'abil', 0); }));
                
                renderDynamicAdvantageRow('list-disc', 'disc', DISCIPLINES);
                renderDynamicAdvantageRow('list-back', 'back', BACKGROUNDS);
                renderDynamicAdvantageRow('custom-talents', 'abil', [], true);
                renderDynamicAdvantageRow('custom-skills', 'abil', [], true);
                renderDynamicAdvantageRow('custom-knowledges', 'abil', [], true);
                
                renderDerangementsList(); 
                
                VIRTUES.forEach(v => { window.state.dots.virt[v] = 1; renderRow('list-virt', v, 'virt', 1); });

                VIT.forEach(v => { const d = document.createElement('div'); d.innerHTML = `<label class="label-text">${v}</label><input type="text" id="bio-${v}">`; document.getElementById('vitals-create-inputs').appendChild(d); });

                renderDynamicTraitRow('merits-list-create', 'Merit', V20_MERITS_LIST);
                renderDynamicTraitRow('flaws-list-create', 'Flaw', V20_FLAWS_LIST);
                
                renderInventoryList();

                for(let i=0; i<8; i++) {
                    const d2 = document.createElement('div'); d2.className = 'flex items-center gap-2 mb-2';
                    d2.innerHTML = `<input type="text" id="ot-n-${i}" placeholder="Other..." class="w-40 text-[11px] font-bold"><div class="dot-row" id="ot-dr-${i}"></div>`;
                    document.getElementById('other-traits-rows-create').appendChild(d2);
                    const dr = d2.querySelector('.dot-row');
                    dr.innerHTML = renderDots(0, 5);
                    dr.onclick = (e) => {
                        const n = document.getElementById(`ot-n-${i}`).value || `Other_${i}`;
                        if(e.target.classList.contains('dot')) { 
                            let v = parseInt(e.target.dataset.v); 
                            const currentVal = window.state.dots.other[n] || 0;
                            if (v === currentVal) v = v - 1;
                            window.state.dots.other[n] = v; 
                            dr.innerHTML = renderDots(v, 5); 
                        }
                    };
                }

                document.getElementById('c-freebie-total').oninput = window.updatePools;

                document.querySelectorAll('.prio-btn').forEach(b => b.onclick = (e) => {
                    const {cat, group, v} = e.target.dataset;
                    const catGroups = cat === 'attr' ? ['Physical', 'Social', 'Mental'] : ['Talents', 'Skills', 'Knowledges'];
                    
                    catGroups.forEach(g => {
                        if (window.state.prios[cat][g] === parseInt(v)) {
                            window.state.prios[cat][g] = null;
                            if (cat === 'attr') {
                                ATTRIBUTES[g].forEach(a => window.state.dots.attr[a] = 1);
                                ATTRIBUTES[g].forEach(a => {
                                    const row = document.querySelector(`.dot-row[data-n="${a}"][data-t="attr"]`);
                                    if(row) row.innerHTML = renderDots(1, 5);
                                });
                            } else {
                                ABILITIES[g].forEach(a => window.state.dots.abil[a] = 0);
                                if (window.state.customAbilityCategories) {
                                    Object.entries(window.state.customAbilityCategories).forEach(([name, c]) => {
                                        if (c === g) window.state.dots.abil[name] = 0;
                                    });
                                }
                                ABILITIES[g].forEach(a => {
                                    const row = document.querySelector(`.dot-row[data-n="${a}"][data-t="abil"]`);
                                    if(row) row.innerHTML = renderDots(0, 5);
                                });
                                const allCustom = document.querySelectorAll('#custom-talents .advantage-row, #custom-skills .advantage-row, #custom-knowledges .advantage-row');
                                allCustom.forEach(r => {
                                    const dot = r.querySelector('.dot-row');
                                    if(dot) dot.innerHTML = renderDots(0,5);
                                });
                            }
                        }
                    });

                    window.state.prios[cat][group] = parseInt(v);
                    
                    document.querySelectorAll(`.prio-btn[data-cat="${cat}"]`).forEach(el => {
                        const isActive = window.state.prios[cat][el.dataset.group] == el.dataset.v;
                        el.classList.toggle('active', isActive);
                    });
                    
                    updatePools();
                });

                window.updatePools = updatePools;
                renderBloodBondRow();
                renderDynamicHavenRow();

                await refreshList();
                window.changeStep(1); 
                updatePools();
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>
